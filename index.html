<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Git Form Builder</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .mode-switcher {
            background: #f8f9fa;
            padding: 20px;
            display: flex;
            justify-content: center;
            gap: 20px;
            border-bottom: 1px solid #dee2e6;
        }

        .mode-btn {
            padding: 12px 30px;
            border: 2px solid #007bff;
            background: white;
            color: #007bff;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            font-size: 16px;
        }

        .mode-btn.active {
            background: #007bff;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,123,255,0.3);
        }

        .mode-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,123,255,0.3);
        }

        .content {
            padding: 30px;
            min-height: 500px;
        }

        .form-designer {
            display: none;
        }

        .form-designer.active {
            display: block;
        }

        .designer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }

        .form-title-input {
            flex: 1;
            padding: 15px;
            font-size: 1.5em;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            margin-right: 20px;
        }

        .add-question-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .add-question-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40,167,69,0.3);
        }

        .question-item {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .question-item:hover {
            border-color: #007bff;
            box-shadow: 0 5px 15px rgba(0,123,255,0.1);
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .question-type-select {
            padding: 8px 15px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            background: white;
        }

        .delete-question-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .delete-question-btn:hover {
            background: #c82333;
            transform: scale(1.05);
        }

        .question-text-input {
            width: 100%;
            padding: 12px;
            font-size: 1.1em;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 15px;
            resize: vertical;
        }

        .options-container {
            margin-top: 15px;
        }

        .option-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
        }

        .option-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
        }

        .add-option-btn, .remove-option-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }

        .add-option-btn {
            background: #28a745;
            color: white;
        }

        .remove-option-btn {
            background: #dc3545;
            color: white;
        }

        .file-upload-section {
            background: #e3f2fd;
            border: 2px dashed #2196f3;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            text-align: center;
        }

        .file-upload-btn {
            background: #2196f3;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s ease;
        }

        .file-upload-btn:hover {
            background: #1976d2;
            transform: translateY(-1px);
        }

        .file-input {
            display: none;
        }

        .file-status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 4px;
            font-size: 14px;
        }

        .file-status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .file-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .dropdown-preview {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }

        .dropdown-preview select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .image-capture-section {
            background: #f0f8ff;
            border: 2px dashed #4CAF50;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
        }

        .image-capture-toggle {
            margin: 10px 0;
        }

        .image-capture-toggle input[type="checkbox"] {
            transform: scale(1.2);
            margin-right: 8px;
        }

        .image-upload-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .image-btn {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .image-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76,175,80,0.3);
        }

        .camera-input, .file-image-input {
            display: none;
        }

        .image-preview-container {
            margin: 15px 0;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        .image-preview {
            position: relative;
            border: 2px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .image-preview img {
            width: 150px;
            height: 150px;
            object-fit: cover;
            display: block;
        }

        .image-preview .remove-image {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .form-viewer {
            display: none;
        }

        .form-viewer.active {
            display: block;
        }

        .form-title {
            font-size: 2em;
            margin-bottom: 30px;
            color: #333;
            text-align: center;
            padding-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }

        .answer-question {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .answer-question h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .answer-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .answer-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }

        .radio-group, .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .radio-option, .checkbox-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-radius: 8px;
            transition: background-color 0.3s ease;
        }

        .radio-option:hover, .checkbox-option:hover {
            background-color: #f8f9fa;
        }

        .rating-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
        }

        .star-rating {
            display: flex;
            gap: 5px;
            font-size: 2em;
            user-select: none;
        }

        .star {
            color: #ddd;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .star:hover,
        .star.active {
            color: #ffd700;
            transform: scale(1.1);
        }

        .star:hover ~ .star {
            color: #ddd;
        }

        .rating-labels {
            display: flex;
            justify-content: space-between;
            width: 280px;
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .rating-preview {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            text-align: center;
        }

        .rating-preview .star-rating {
            justify-content: center;
            margin: 10px 0;
        }

        .rating-value {
            margin-left: 15px;
            font-weight: bold;
            color: #007bff;
            font-size: 1.2em;
        }

        .submit-section {
            text-align: center;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid #e9ecef;
        }

        .submit-btn {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.1em;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .submit-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,123,255,0.3);
        }

        .export-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
        }

        .export-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 0 10px;
            transition: all 0.3s ease;
        }

        .export-btn:hover {
            background: #138496;
            transform: translateY(-2px);
        }

        .export-pdf-btn {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            margin: 0 10px;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .export-pdf-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220,53,69,0.3);
        }

        .save-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
        }

        .save-btn {
            background: #ffc107;
            color: #856404;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .save-btn:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }

        .instructions {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            color: #0c5460;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .content {
                padding: 20px;
            }
            
            .mode-switcher {
                flex-direction: column;
                gap: 10px;
            }
            
            .designer-header {
                flex-direction: column;
                gap: 15px;
            }
            
            .form-title-input {
                margin-right: 0;
                margin-bottom: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Git Form Builder</h1>
            <p>Erstellen Sie professionelle Formulare direkt in Ihrem Git Repository</p>
        </div>

        <div class="mode-switcher">
            <button class="mode-btn active" onclick="switchMode('design')">üìù Entwurfsmodus</button>
            <button class="mode-btn" onclick="switchMode('answer')">üìã Antwortmodus</button>
        </div>

        <div class="content">
            <!-- Design Mode -->
            <div class="form-designer active" id="designMode">
                <div class="instructions">
                    <strong>Hinweis:</strong> Nach dem Erstellen Ihres Formulars k√∂nnen Sie es mit dem "Formular speichern" Button speichern. 
                    Die Formulardefinition wird direkt in diese HTML-Datei eingebettet. Committen Sie die Datei anschlie√üend in Ihr Git Repository.
                    <br><br>
                    <strong>üîΩ Dropdown-Men√ºs:</strong> Bei Dropdown-Fragen k√∂nnen Sie Optionen aus Textdateien (.txt oder .csv) laden. 
                    Erstellen Sie eine Datei mit einer Option pro Zeile. Kommentare mit # am Zeilenanfang werden ignoriert.
                </div>
                
                <div class="designer-header">
                    <input type="text" class="form-title-input" id="formTitle" placeholder="Formulartitel eingeben..." value="Mein Formular">
                    <button class="add-question-btn" onclick="addQuestion()">‚ûï Frage hinzuf√ºgen</button>
                </div>

                <div id="questionsContainer">
                    <!-- Questions will be added here dynamically -->
                </div>

                <div class="save-section">
                    <h3>üíæ Formular speichern</h3>
                    <p>Speichert die Formulardefinition direkt in diese HTML-Datei</p>
                    <button class="save-btn" onclick="saveForm()">Formular speichern</button>
                </div>
            </div>

            <!-- Answer Mode -->
            <div class="form-viewer" id="answerMode">
                <div id="formDisplay">
                    <div class="form-title">Noch kein Formular erstellt</div>
                    <p style="text-align: center; color: #666;">Wechseln Sie zum Entwurfsmodus, um ein Formular zu erstellen.</p>
                </div>

                <div class="export-section" id="exportSection" style="display: none;">
                    <h3>üìÑ Survey abschlie√üen</h3>
                    <p>Ihre Antworten werden als PDF-Report generiert und die Survey wird zur√ºckgesetzt</p>
                    <button class="export-pdf-btn" onclick="completeSurvey()">üìÑ Survey abschlie√üen & PDF generieren</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Form Data Storage (will be updated dynamically) -->
    <script id="formData" type="application/json">
    {
        "title": "",
        "questions": [],
        "responses": []
    }
    </script>

    <script>
        let currentMode = 'design';
        let formData = {
            title: "",
            questions: [],
            responses: []
        };
        let questionCounter = 0;
        let imageCounter = 0;

        // Load existing form data on page load
        window.addEventListener('load', function() {
            loadFormData();
            renderDesignMode();
            renderAnswerMode();
        });

        function loadFormData() {
            try {
                const formDataElement = document.getElementById('formData');
                const data = JSON.parse(formDataElement.textContent);
                formData = data;
                document.getElementById('formTitle').value = formData.title || 'Mein Formular';
            } catch (e) {
                console.log('No existing form data found, starting fresh');
            }
        }

        function switchMode(mode) {
            currentMode = mode;
            
            // Update button states
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Show/hide content
            document.getElementById('designMode').classList.toggle('active', mode === 'design');
            document.getElementById('answerMode').classList.toggle('active', mode === 'answer');
            
            if (mode === 'answer') {
                renderAnswerMode();
            }
        }

        function addQuestion() {
            questionCounter++;
            const question = {
                id: questionCounter,
                type: 'text',
                text: '',
                options: [],
                required: false,
                imageCapture: false,
                images: []
            };
            
            formData.questions.push(question);
            renderDesignMode();
        }

        function removeQuestion(questionId) {
            formData.questions = formData.questions.filter(q => q.id !== questionId);
            renderDesignMode();
        }

        function updateQuestion(questionId, field, value) {
            const question = formData.questions.find(q => q.id === questionId);
            if (question) {
                question[field] = value;
                if (field === 'type' && ['radio', 'checkbox', 'dropdown'].includes(value) && question.options.length === 0) {
                    question.options = ['Option 1', 'Option 2'];
                }
                renderDesignMode();
            }
        }

        function addOption(questionId) {
            const question = formData.questions.find(q => q.id === questionId);
            if (question) {
                question.options.push(`Option ${question.options.length + 1}`);
                renderDesignMode();
            }
        }

        function removeOption(questionId, optionIndex) {
            const question = formData.questions.find(q => q.id === questionId);
            if (question && question.options.length > 1) {
                question.options.splice(optionIndex, 1);
                renderDesignMode();
            }
        }

        function updateOption(questionId, optionIndex, value) {
            const question = formData.questions.find(q => q.id === questionId);
            if (question) {
                question.options[optionIndex] = value;
            }
        }

        function renderDesignMode() {
            const container = document.getElementById('questionsContainer');
            container.innerHTML = '';

            formData.questions.forEach(question => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question-item';
                questionDiv.innerHTML = `
                    <div class="question-header">
                        <select class="question-type-select" onchange="updateQuestion(${question.id}, 'type', this.value)">
                            <option value="text" ${question.type === 'text' ? 'selected' : ''}>Textfeld</option>
                            <option value="textarea" ${question.type === 'textarea' ? 'selected' : ''}>Textbereich</option>
                            <option value="radio" ${question.type === 'radio' ? 'selected' : ''}>Einzelauswahl</option>
                            <option value="checkbox" ${question.type === 'checkbox' ? 'selected' : ''}>Mehrfachauswahl</option>
                            <option value="dropdown" ${question.type === 'dropdown' ? 'selected' : ''}>Dropdown-Men√º</option>
                            <option value="rating" ${question.type === 'rating' ? 'selected' : ''}>‚≠ê Sterne-Bewertung (1-5)</option>
                            <option value="number" ${question.type === 'number' ? 'selected' : ''}>Zahl</option>
                            <option value="email" ${question.type === 'email' ? 'selected' : ''}>E-Mail</option>
                            <option value="date" ${question.type === 'date' ? 'selected' : ''}>Datum</option>
                        </select>
                        <button class="delete-question-btn" onclick="removeQuestion(${question.id})">üóëÔ∏è L√∂schen</button>
                    </div>
                    <textarea class="question-text-input" placeholder="Frage eingeben..." 
                              onchange="updateQuestion(${question.id}, 'text', this.value)">${question.text}</textarea>
                    ${renderQuestionOptions(question)}
                    ${renderImageCaptureOption(question)}
                `;
                container.appendChild(questionDiv);
            });
        }

        function renderQuestionOptions(question) {
            if (!['radio', 'checkbox', 'dropdown', 'rating'].includes(question.type)) {
                return '';
            }

            let optionsHtml = '';

            // Rating preview
            if (question.type === 'rating') {
                optionsHtml += `
                    <div class="rating-preview">
                        <h4>‚≠ê Sterne-Bewertung Vorschau</h4>
                        <div class="star-rating">
                            <span class="star">‚òÖ</span>
                            <span class="star">‚òÖ</span>
                            <span class="star">‚òÖ</span>
                            <span class="star active">‚òÖ</span>
                            <span class="star">‚òÜ</span>
                        </div>
                        <div class="rating-labels">
                            <span>Sehr schlecht</span>
                            <span>Schlecht</span>
                            <span>Okay</span>
                            <span>Gut</span>
                            <span>Sehr gut</span>
                        </div>
                        <p style="margin-top: 10px; color: #666; font-size: 12px;">
                            Nutzer k√∂nnen durch Klicken auf die Sterne eine Bewertung von 1-5 abgeben
                        </p>
                    </div>
                `;
                return optionsHtml;
            }

            optionsHtml += '<div class="options-container"><h4>Antwortoptionen:</h4>';
            
            // File upload section for dropdown
            if (question.type === 'dropdown') {
                optionsHtml += `
                    <div class="file-upload-section">
                        <p><strong>üìÅ Optionen aus Textdatei laden</strong></p>
                        <p style="font-size: 12px; color: #666; margin: 5px 0;">Unterst√ºtzte Formate: .txt, .csv - Eine Option pro Zeile</p>
                        <input type="file" class="file-input" id="fileInput_${question.id}" accept=".txt,.csv" onchange="loadOptionsFromFile(${question.id}, this)">
                        <button type="button" class="file-upload-btn" onclick="document.getElementById('fileInput_${question.id}').click()">
                            üìÇ Datei ausw√§hlen
                        </button>
                        <button type="button" class="file-upload-btn" onclick="clearOptions(${question.id})">
                            üóëÔ∏è Optionen l√∂schen
                        </button>
                        <div id="fileStatus_${question.id}" class="file-status" style="display: none;"></div>
                    </div>
                `;
            }
            
            question.options.forEach((option, index) => {
                optionsHtml += `
                    <div class="option-item">
                        <input type="text" class="option-input" value="${option}" 
                               onchange="updateOption(${question.id}, ${index}, this.value)">
                        <button class="remove-option-btn" onclick="removeOption(${question.id}, ${index})">‚àí</button>
                    </div>
                `;
            });
            
            optionsHtml += `
                <button class="add-option-btn" onclick="addOption(${question.id})">+ Option hinzuf√ºgen</button>
            `;

            // Preview for dropdown
            if (question.type === 'dropdown' && question.options.length > 0) {
                optionsHtml += `
                    <div class="dropdown-preview">
                        <strong>Vorschau:</strong>
                        <select disabled>
                            <option>Bitte w√§hlen...</option>
                            ${question.options.map(option => `<option>${option}</option>`).join('')}
                        </select>
                    </div>
                `;
            }

            optionsHtml += '</div>';
            
            return optionsHtml;
        }

        function renderImageCaptureOption(question) {
            return `
                <div class="image-capture-section">
                    <div class="image-capture-toggle">
                        <label>
                            <input type="checkbox" ${question.imageCapture ? 'checked' : ''} 
                                   onchange="updateQuestion(${question.id}, 'imageCapture', this.checked)">
                            üì∏ Bilderfassung aktivieren (Kamera/Galerie)
                        </label>
                    </div>
                    ${question.imageCapture ? `
                        <p style="font-size: 12px; color: #666; margin: 5px 0;">
                            Nutzer k√∂nnen zu dieser Frage Bilder hinzuf√ºgen
                        </p>
                    ` : ''}
                </div>
            `;
        }

        function renderAnswerMode() {
            const container = document.getElementById('formDisplay');
            
            if (formData.questions.length === 0) {
                container.innerHTML = `
                    <div class="form-title">Noch kein Formular erstellt</div>
                    <p style="text-align: center; color: #666;">Wechseln Sie zum Entwurfsmodus, um ein Formular zu erstellen.</p>
                `;
                document.getElementById('exportSection').style.display = 'none';
                return;
            }

            let html = `<div class="form-title">${formData.title || 'Formular'}</div>`;
            
            formData.questions.forEach(question => {
                html += `<div class="answer-question">
                    <h3>${question.text}</h3>
                    ${renderAnswerInput(question)}
                </div>`;
            });
            
            html += `
                <div class="submit-section">
                    <p style="color: #666; margin-bottom: 15px;">√úberpr√ºfen Sie Ihre Antworten und schlie√üen Sie die Survey ab</p>
                </div>
            `;
            
            container.innerHTML = html;
            document.getElementById('exportSection').style.display = 'block';
            
            // Add hover effects for rating stars
            setTimeout(addRatingHoverEffects, 100);
        }

        function renderAnswerInput(question) {
            let inputHtml = '';
            
            switch (question.type) {
                case 'text':
                case 'email':
                case 'number':
                case 'date':
                    inputHtml = `<input type="${question.type}" class="answer-input" id="answer_${question.id}">`;
                    break;
                
                case 'textarea':
                    inputHtml = `<textarea class="answer-input" id="answer_${question.id}" rows="4"></textarea>`;
                    break;
                
                case 'dropdown':
                    inputHtml = `<select class="answer-input" id="answer_${question.id}">
                        <option value="">Bitte w√§hlen...</option>`;
                    question.options.forEach(option => {
                        inputHtml += `<option value="${option}">${option}</option>`;
                    });
                    inputHtml += '</select>';
                    break;
                
                case 'rating':
                    inputHtml = `
                        <div class="rating-container">
                            <div class="star-rating" id="stars_${question.id}">
                                <span class="star" data-rating="1" onclick="setRating(${question.id}, 1)">‚òÖ</span>
                                <span class="star" data-rating="2" onclick="setRating(${question.id}, 2)">‚òÖ</span>
                                <span class="star" data-rating="3" onclick="setRating(${question.id}, 3)">‚òÖ</span>
                                <span class="star" data-rating="4" onclick="setRating(${question.id}, 4)">‚òÖ</span>
                                <span class="star" data-rating="5" onclick="setRating(${question.id}, 5)">‚òÖ</span>
                            </div>
                            <span class="rating-value" id="ratingValue_${question.id}">-</span>
                            <input type="hidden" id="answer_${question.id}" value="">
                        </div>
                        <div class="rating-labels">
                            <span>Sehr schlecht</span>
                            <span>Schlecht</span>
                            <span>Okay</span>
                            <span>Gut</span>
                            <span>Sehr gut</span>
                        </div>
                    `;
                    break;
                
                case 'radio':
                    inputHtml = '<div class="radio-group">';
                    question.options.forEach((option, index) => {
                        inputHtml += `
                            <div class="radio-option">
                                <input type="radio" name="answer_${question.id}" value="${option}" id="radio_${question.id}_${index}">
                                <label for="radio_${question.id}_${index}">${option}</label>
                            </div>
                        `;
                    });
                    inputHtml += '</div>';
                    break;
                
                case 'checkbox':
                    inputHtml = '<div class="checkbox-group">';
                    question.options.forEach((option, index) => {
                        inputHtml += `
                            <div class="checkbox-option">
                                <input type="checkbox" value="${option}" id="checkbox_${question.id}_${index}" name="answer_${question.id}">
                                <label for="checkbox_${question.id}_${index}">${option}</label>
                            </div>
                        `;
                    });
                    inputHtml += '</div>';
                    break;
                
                default:
                    inputHtml = `<input type="text" class="answer-input" id="answer_${question.id}">`;
                    break;
            }

            // Add image capture if enabled
            if (question.imageCapture) {
                inputHtml += `
                    <div class="image-capture-section">
                        <h4>üì∏ Bilder hinzuf√ºgen</h4>
                        <div class="image-upload-controls">
                            <button type="button" class="image-btn" onclick="captureFromCamera(${question.id})">
                                üì∑ Kamera
                            </button>
                            <button type="button" class="image-btn" onclick="selectFromGallery(${question.id})">
                                üñºÔ∏è Galerie
                            </button>
                        </div>
                        <input type="file" class="camera-input" id="camera_${question.id}" accept="image/*" capture="environment" onchange="handleImageCapture(${question.id}, this, 'camera')">
                        <input type="file" class="file-image-input" id="gallery_${question.id}" accept="image/*" multiple onchange="handleImageCapture(${question.id}, this, 'gallery')">
                        <div class="image-preview-container" id="imageContainer_${question.id}"></div>
                        <div class="image-count" id="imageCount_${question.id}">0 Bilder hinzugef√ºgt</div>
                    </div>
                `;
            }

            return inputHtml;
        }

        function submitForm() {
            const response = {
                timestamp: new Date().toISOString(),
                answers: {}
            };

            formData.questions.forEach(question => {
                let answer = '';
                let images = [];
                
                switch (question.type) {
                    case 'radio':
                        const radioInput = document.querySelector(`input[name="answer_${question.id}"]:checked`);
                        answer = radioInput ? radioInput.value : '';
                        break;
                    
                    case 'checkbox':
                        const checkboxInputs = document.querySelectorAll(`input[name="answer_${question.id}"]:checked`);
                        answer = Array.from(checkboxInputs).map(input => input.value);
                        break;
                    
                    case 'dropdown':
                        const dropdownInput = document.getElementById(`answer_${question.id}`);
                        answer = dropdownInput ? dropdownInput.value : '';
                        break;
                    case 'rating':
                        const ratingInput = document.getElementById(`answer_${question.id}`);
                        answer = ratingInput ? ratingInput.value : '';
                        break;
                    
                    default:
                        const input = document.getElementById(`answer_${question.id}`);
                        answer = input ? input.value : '';
                        break;
                }

                // Collect images if image capture is enabled
                if (question.imageCapture && question.images) {
                    images = [...question.images];
                }
                
                response.answers[question.id] = {
                    question: question.text,
                    answer: answer,
                    images: images
                };
            });

            formData.responses.push(response);
            
            alert('‚úÖ Antworten erfolgreich √ºbermittelt! Sie k√∂nnen sie nun exportieren.');
            
            // Clear form and images
            formData.questions.forEach(question => {
                switch (question.type) {
                    case 'radio':
                        document.querySelectorAll(`input[name="answer_${question.id}"]`).forEach(input => input.checked = false);
                        break;
                    case 'checkbox':
                        document.querySelectorAll(`input[name="answer_${question.id}"]`).forEach(input => input.checked = false);
                        break;
                    case 'dropdown':
                        const dropdownInput = document.getElementById(`answer_${question.id}`);
                        if (dropdownInput) dropdownInput.selectedIndex = 0;
                        break;
                    case 'rating':
                        const ratingInput = document.getElementById(`answer_${question.id}`);
                        if (ratingInput) ratingInput.value = '';
                        const starsContainer = document.getElementById(`stars_${question.id}`);
                        const ratingValue = document.getElementById(`ratingValue_${question.id}`);
                        if (starsContainer) {
                            const stars = starsContainer.querySelectorAll('.star');
                            stars.forEach(star => {
                                star.classList.remove('active');
                                star.style.color = '#ddd';
                            });
                        }
                        if (ratingValue) ratingValue.textContent = '-';
                        break;
                    default:
                        const input = document.getElementById(`answer_${question.id}`);
                        if (input) input.value = '';
                        break;
                }
                
                // Clear images
                if (question.imageCapture) {
                    question.images = [];
                    const imageContainer = document.getElementById(`imageContainer_${question.id}`);
                    if (imageContainer) imageContainer.innerHTML = '';
                    const imageCount = document.getElementById(`imageCount_${question.id}`);
                    if (imageCount) imageCount.textContent = '0 Bilder hinzugef√ºgt';
                }
            });
        }

        function saveForm() {
            formData.title = document.getElementById('formTitle').value;
            
            // Update the embedded JSON
            const formDataElement = document.getElementById('formData');
            formDataElement.textContent = JSON.stringify(formData, null, 2);
            
            alert('‚úÖ Formular gespeichert! Committen Sie diese HTML-Datei in Ihr Git Repository, damit andere Teammitglieder auf das Formular zugreifen k√∂nnen.');
        }

        function exportAsJSON() {
            const dataStr = JSON.stringify(formData.responses, null, 2);
            downloadFile(dataStr, 'form-responses.json', 'application/json');
        }

        function exportAsCSV() {
            if (formData.responses.length === 0) {
                alert('Keine Antworten zum Exportieren vorhanden.');
                return;
            }

            let csv = 'Zeitstempel';
            
            // Headers
            const firstResponse = formData.responses[0];
            Object.values(firstResponse.answers).forEach(answer => {
                csv += ',"' + answer.question.replace(/"/g, '""') + '"';
                csv += ',"' + answer.question.replace(/"/g, '""') + ' (Bilder)"';
            });
            csv += '\n';

            // Data rows
            formData.responses.forEach(response => {
                csv += '"' + response.timestamp + '"';
                Object.values(response.answers).forEach(answer => {
                    const answerText = Array.isArray(answer.answer) ? answer.answer.join('; ') : answer.answer;
                    csv += ',"' + String(answerText).replace(/"/g, '""') + '"';
                    
                    const imageCount = answer.images ? answer.images.length : 0;
                    csv += ',"' + imageCount + ' Bild(er)"';
                });
                csv += '\n';
            });

            downloadFile(csv, 'form-responses.csv', 'text/csv');
        }

        function exportAsTXT() {
            let txt = `Formular: ${formData.title}\n`;
            txt += `Exportiert am: ${new Date().toLocaleString('de-DE')}\n`;
            txt += `Anzahl Antworten: ${formData.responses.length}\n\n`;
            txt += '='.repeat(60) + '\n\n';

            formData.responses.forEach((response, index) => {
                txt += `Antwort ${index + 1}\n`;
                txt += `Zeitstempel: ${new Date(response.timestamp).toLocaleString('de-DE')}\n`;
                txt += '-'.repeat(40) + '\n';
                
                Object.values(response.answers).forEach(answer => {
                    txt += `${answer.question}\n`;
                    const answerText = Array.isArray(answer.answer) ? answer.answer.join(', ') : answer.answer;
                    txt += `Antwort: ${answerText}\n`;
                    
                    if (answer.images && answer.images.length > 0) {
                        txt += `Bilder: ${answer.images.length} Bild(er) hinzugef√ºgt\n`;
                        answer.images.forEach((image, imgIndex) => {
                            txt += `  - Bild ${imgIndex + 1}: ${image.name} (${new Date(image.timestamp).toLocaleString('de-DE')})\n`;
                        });
                    }
                    txt += '\n';
                });
                
                txt += '='.repeat(60) + '\n\n';
            });

            downloadFile(txt, 'form-responses.txt', 'text/plain');
        }

        function downloadFile(content, filename, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function loadOptionsFromFile(questionId, fileInput) {
            const file = fileInput.files[0];
            const statusDiv = document.getElementById(`fileStatus_${questionId}`);
            
            if (!file) {
                return;
            }

            // Validate file type
            const validTypes = ['text/plain', 'text/csv', 'application/csv'];
            const fileExtension = file.name.toLowerCase().split('.').pop();
            
            if (!validTypes.includes(file.type) && !['txt', 'csv'].includes(fileExtension)) {
                showFileStatus(statusDiv, 'Fehler: Nur .txt und .csv Dateien sind erlaubt.', 'error');
                fileInput.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    const lines = content.split('\n')
                        .map(line => line.trim())
                        .filter(line => line.length > 0 && !line.startsWith('#'));
                    
                    if (lines.length === 0) {
                        showFileStatus(statusDiv, 'Fehler: Die Datei enth√§lt keine g√ºltigen Optionen.', 'error');
                        return;
                    }

                    const question = formData.questions.find(q => q.id === questionId);
                    if (question) {
                        question.options = lines;
                        renderDesignMode();
                        showFileStatus(statusDiv, `‚úÖ ${lines.length} Optionen erfolgreich geladen aus "${file.name}"`, 'success');
                    }
                } catch (error) {
                    showFileStatus(statusDiv, `Fehler beim Lesen der Datei: ${error.message}`, 'error');
                }
            };

            reader.onerror = function() {
                showFileStatus(statusDiv, 'Fehler beim Lesen der Datei.', 'error');
            };

            reader.readAsText(file, 'UTF-8');
        }

        function showFileStatus(statusDiv, message, type) {
            statusDiv.textContent = message;
            statusDiv.className = `file-status ${type}`;
            statusDiv.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 3000);
            }
        }

        function clearOptions(questionId) {
            const question = formData.questions.find(q => q.id === questionId);
            if (question) {
                question.options = [];
                renderDesignMode();
                
                const statusDiv = document.getElementById(`fileStatus_${questionId}`);
                showFileStatus(statusDiv, 'üóëÔ∏è Alle Optionen gel√∂scht.', 'success');
            }
        }

        function captureFromCamera(questionId) {
            const input = document.getElementById(`camera_${questionId}`);
            input.click();
        }

        function selectFromGallery(questionId) {
            const input = document.getElementById(`gallery_${questionId}`);
            input.click();
        }

        function handleImageCapture(questionId, input, source) {
            const files = input.files;
            if (!files || files.length === 0) return;

            const question = formData.questions.find(q => q.id === questionId);
            if (!question) return;

            if (!question.images) question.images = [];

            Array.from(files).forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        imageCounter++;
                        const imageData = {
                            id: imageCounter,
                            name: file.name,
                            data: e.target.result,
                            timestamp: new Date().toISOString(),
                            source: source
                        };
                        
                        question.images.push(imageData);
                        updateImagePreview(questionId);
                    };
                    reader.readAsDataURL(file);
                }
            });

            input.value = '';
        }

        function updateImagePreview(questionId) {
            const question = formData.questions.find(q => q.id === questionId);
            if (!question || !question.images) return;

            const container = document.getElementById(`imageContainer_${questionId}`);
            const countElement = document.getElementById(`imageCount_${questionId}`);
            
            if (!container || !countElement) return;

            container.innerHTML = '';
            
            question.images.forEach((image, index) => {
                const previewDiv = document.createElement('div');
                previewDiv.className = 'image-preview';
                previewDiv.innerHTML = `
                    <img src="${image.data}" alt="Bild ${index + 1}">
                    <button class="remove-image" onclick="removeImage(${questionId}, ${image.id})" title="Bild entfernen">√ó</button>
                `;
                container.appendChild(previewDiv);
            });

            countElement.textContent = `${question.images.length} Bild${question.images.length !== 1 ? 'er' : ''} hinzugef√ºgt`;
        }

        function removeImage(questionId, imageId) {
            const question = formData.questions.find(q => q.id === questionId);
            if (question && question.images) {
                question.images = question.images.filter(img => img.id !== imageId);
                updateImagePreview(questionId);
            }
        }

        function setRating(questionId, rating) {
            const starsContainer = document.getElementById(`stars_${questionId}`);
            const ratingValue = document.getElementById(`ratingValue_${questionId}`);
            const hiddenInput = document.getElementById(`answer_${questionId}`);
            
            if (!starsContainer || !ratingValue || !hiddenInput) return;
            
            // Update hidden input value
            hiddenInput.value = rating;
            
            // Update visual display
            const ratingLabels = ['', 'Sehr schlecht', 'Schlecht', 'Okay', 'Gut', 'Sehr gut'];
            ratingValue.textContent = `${rating}/5 - ${ratingLabels[rating]}`;
            
            // Update stars
            const stars = starsContainer.querySelectorAll('.star');
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.classList.add('active');
                    star.style.color = '#ffd700';
                } else {
                    star.classList.remove('active');
                    star.style.color = '#ddd';
                }
            });
        }

        // Add hover effects for rating stars
        function addRatingHoverEffects() {
            document.querySelectorAll('.star-rating').forEach(container => {
                const stars = container.querySelectorAll('.star');
                
                stars.forEach((star, index) => {
                    star.addEventListener('mouseenter', () => {
                        stars.forEach((s, i) => {
                            if (i <= index) {
                                s.style.color = '#ffd700';
                            } else {
                                s.style.color = '#ddd';
                            }
                        });
                    });
                });
                
                container.addEventListener('mouseleave', () => {
                    // Restore original state based on current selection
                    const hiddenInput = container.parentElement.querySelector('input[type="hidden"]');
                    const currentRating = hiddenInput ? parseInt(hiddenInput.value) : 0;
                    
                    stars.forEach((s, i) => {
                        if (i < currentRating) {
                            s.style.color = '#ffd700';
                        } else {
                            s.style.color = '#ddd';
                        }
                    });
                });
            });
        }

        function completeSurvey() {
            // Validate that all questions are answered
            let allAnswered = true;
            let missingQuestions = [];

            formData.questions.forEach(question => {
                let hasAnswer = false;
                
                switch (question.type) {
                    case 'radio':
                        const radioInput = document.querySelector(`input[name="answer_${question.id}"]:checked`);
                        hasAnswer = radioInput && radioInput.value;
                        break;
                    case 'checkbox':
                        const checkboxInputs = document.querySelectorAll(`input[name="answer_${question.id}"]:checked`);
                        hasAnswer = checkboxInputs.length > 0;
                        break;
                    case 'dropdown':
                        const dropdownInput = document.getElementById(`answer_${question.id}`);
                        hasAnswer = dropdownInput && dropdownInput.value;
                        break;
                    case 'rating':
                        const ratingInput = document.getElementById(`answer_${question.id}`);
                        hasAnswer = ratingInput && ratingInput.value;
                        break;
                    default:
                        const input = document.getElementById(`answer_${question.id}`);
                        hasAnswer = input && input.value.trim() !== '';
                        break;
                }

                if (!hasAnswer) {
                    allAnswered = false;
                    missingQuestions.push(question.text || `Frage ${question.id}`);
                }
            });

            if (!allAnswered) {
                alert(`Bitte beantworten Sie alle Fragen:\n\n${missingQuestions.join('\n')}`);
                return;
            }

            // Collect answers
            const response = {
                timestamp: new Date().toISOString(),
                answers: {}
            };

            formData.questions.forEach(question => {
                let answer = '';
                let images = [];
                
                switch (question.type) {
                    case 'radio':
                        const radioInput = document.querySelector(`input[name="answer_${question.id}"]:checked`);
                        answer = radioInput ? radioInput.value : '';
                        break;
                    case 'checkbox':
                        const checkboxInputs = document.querySelectorAll(`input[name="answer_${question.id}"]:checked`);
                        answer = Array.from(checkboxInputs).map(input => input.value);
                        break;
                    case 'dropdown':
                        const dropdownInput = document.getElementById(`answer_${question.id}`);
                        answer = dropdownInput ? dropdownInput.value : '';
                        break;
                    default:
                        const input = document.getElementById(`answer_${question.id}`);
                        answer = input ? input.value : '';
                        break;
                }

                // Collect images if image capture is enabled
                if (question.imageCapture && question.images) {
                    images = [...question.images];
                }
                
                response.answers[question.id] = {
                    question: question.text,
                    answer: answer,
                    images: images
                };
            });

            // Generate PDF immediately
            generateSurveyPDF(response);

            // Reset survey after successful PDF generation
            resetSurvey();
        }

        function generateSurveyPDF(response) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            let yPosition = 30;
            const pageHeight = doc.internal.pageSize.height;
            const marginLeft = 25;
            const marginRight = 25;
            const pageWidth = doc.internal.pageSize.width - marginLeft - marginRight;
            
            // Helper function to check if we need a new page
            const checkNewPage = (requiredSpace = 30) => {
                if (yPosition > pageHeight - requiredSpace) {
                    doc.addPage();
                    yPosition = 30;
                    return true;
                }
                return false;
            };

            // Helper function to add header line
            const addHeaderLine = () => {
                doc.setLineWidth(0.5);
                doc.setDrawColor(70, 130, 180); // Steel Blue
                doc.line(marginLeft, 20, pageWidth + marginLeft, 20);
            };

            // Main Header
            addHeaderLine();
            doc.setFontSize(28);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(40, 40, 40);
            doc.text(formData.title || 'Survey Report', marginLeft, yPosition);
            yPosition += 15;

            // Subtitle line
            doc.setLineWidth(2);
            doc.setDrawColor(70, 130, 180);
            doc.line(marginLeft, yPosition, pageWidth + marginLeft, yPosition);
            yPosition += 20;

            // Meta Information Box
            doc.setFillColor(248, 249, 250); // Light gray background
            doc.setDrawColor(220, 220, 220);
            doc.roundedRect(marginLeft, yPosition, pageWidth, 25, 3, 3, 'FD');
            
            doc.setFontSize(11);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(100, 100, 100);
            doc.text('Abgeschlossen am:', marginLeft + 10, yPosition + 10);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(60, 60, 60);
            doc.text(new Date(response.timestamp).toLocaleString('de-DE'), marginLeft + 10, yPosition + 18);
            
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(100, 100, 100);
            doc.text('Anzahl Fragen:', marginLeft + 110, yPosition + 10);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(60, 60, 60);
            doc.text(Object.keys(response.answers).length.toString(), marginLeft + 110, yPosition + 18);
            
            yPosition += 40;

            // Process each answer
            Object.values(response.answers).forEach((answer, index) => {
                checkNewPage(60);

                // Question Container
                doc.setFillColor(255, 255, 255);
                doc.setDrawColor(230, 230, 230);
                const questionBoxHeight = answer.images && answer.images.length > 0 ? 
                    Math.max(80, 40 + (answer.images.length * 65)) : 50;
                
                doc.roundedRect(marginLeft, yPosition, pageWidth, questionBoxHeight, 2, 2, 'FD');
                
                // Question Number Circle
                doc.setFillColor(70, 130, 180);
                doc.circle(marginLeft + 15, yPosition + 15, 8, 'F');
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(255, 255, 255);
                const questionNumber = (index + 1).toString();
                const numberWidth = doc.getTextWidth(questionNumber);
                doc.text(questionNumber, marginLeft + 15 - (numberWidth / 2), yPosition + 19);

                // Question Text
                doc.setFontSize(13);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(40, 40, 40);
                const questionLines = doc.splitTextToSize(answer.question, pageWidth - 50);
                doc.text(questionLines, marginLeft + 30, yPosition + 15);
                
                let answerYPos = yPosition + 15 + (questionLines.length * 6);

                // Answer Text
                doc.setFontSize(11);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(80, 80, 80);
                
                let answerText = '';
                if (Array.isArray(answer.answer)) {
                    answerText = answer.answer.length > 0 ? answer.answer.join(' ‚Ä¢ ') : 'Keine Auswahl';
                } else if (answer.answer) {
                    // Check if this is a rating question
                    const questionObj = formData.questions.find(q => q.text === answer.question);
                    if (questionObj && questionObj.type === 'rating') {
                        const rating = parseInt(answer.answer);
                        if (rating >= 1 && rating <= 5) {
                            const stars = '‚òÖ'.repeat(rating) + '‚òÜ'.repeat(5 - rating);
                            answerText = `${stars} (${rating}/5)`;
                        } else {
                            answerText = answer.answer;
                        }
                    } else {
                        answerText = answer.answer;
                    }
                } else {
                    answerText = 'Keine Antwort';
                }
                
                // Answer with subtle background
                doc.setFillColor(250, 252, 255);
                const answerLines = doc.splitTextToSize(answerText, pageWidth - 50);
                const answerBoxHeight = Math.max(12, answerLines.length * 5 + 6);
                doc.roundedRect(marginLeft + 30, answerYPos + 2, pageWidth - 50, answerBoxHeight, 1, 1, 'F');
                
                doc.setTextColor(60, 60, 60);
                doc.text(answerLines, marginLeft + 35, answerYPos + 8);
                answerYPos += answerBoxHeight + 8;

                // Images Section
                if (answer.images && answer.images.length > 0) {
                    // Images header
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(70, 130, 180);
                    doc.text(`üì∑ Anh√§nge (${answer.images.length})`, marginLeft + 30, answerYPos);
                    answerYPos += 8;

                    // Images in a grid layout
                    let imageX = marginLeft + 30;
                    let imageY = answerYPos;
                    const imageSpacing = 5;
                    const imagesPerRow = 3;
                    
                    answer.images.forEach((image, imageIndex) => {
                        try {
                            // Smaller, professional image size
                            const maxWidth = 45;
                            const maxHeight = 35;
                            
                            // Create image border
                            doc.setDrawColor(200, 200, 200);
                            doc.setLineWidth(0.5);
                            doc.roundedRect(imageX - 1, imageY - 1, maxWidth + 2, maxHeight + 2, 1, 1, 'S');
                            
                            // Add image
                            doc.addImage(image.data, 'JPEG', imageX, imageY, maxWidth, maxHeight);
                            
                            // Image number badge
                            doc.setFillColor(70, 130, 180);
                            doc.circle(imageX + maxWidth - 6, imageY + 6, 4, 'F');
                            doc.setFontSize(7);
                            doc.setFont('helvetica', 'bold');
                            doc.setTextColor(255, 255, 255);
                            const imgNum = (imageIndex + 1).toString();
                            const imgNumWidth = doc.getTextWidth(imgNum);
                            doc.text(imgNum, imageX + maxWidth - 6 - (imgNumWidth / 2), imageY + 8);
                            
                            // Image timestamp (very small)
                            doc.setFontSize(6);
                            doc.setFont('helvetica', 'normal');
                            doc.setTextColor(120, 120, 120);
                            const timestamp = new Date(image.timestamp).toLocaleTimeString('de-DE', { 
                                hour: '2-digit', 
                                minute: '2-digit' 
                            });
                            doc.text(timestamp, imageX, imageY + maxHeight + 4);
                            
                            // Calculate next image position
                            imageX += maxWidth + imageSpacing;
                            
                            // Move to next row if needed
                            if ((imageIndex + 1) % imagesPerRow === 0 && imageIndex < answer.images.length - 1) {
                                imageX = marginLeft + 30;
                                imageY += maxHeight + 12;
                            }
                            
                        } catch (error) {
                            console.error('Error adding image to PDF:', error);
                            doc.setFontSize(8);
                            doc.setFont('helvetica', 'italic');
                            doc.setTextColor(200, 100, 100);
                            doc.text(`[Bild ${imageIndex + 1} nicht verf√ºgbar]`, imageX, imageY + 10);
                            imageX += 50;
                        }
                    });
                }

                yPosition += questionBoxHeight + 15;
            });

            // Footer with generation info
            const footerY = pageHeight - 15;
            doc.setLineWidth(0.3);
            doc.setDrawColor(200, 200, 200);
            doc.line(marginLeft, footerY - 5, pageWidth + marginLeft, footerY - 5);
            
            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(140, 140, 140);
            doc.text('Generiert mit Git Form Builder', marginLeft, footerY);
            doc.text(`Seite ${doc.internal.getCurrentPageInfo().pageNumber}`, pageWidth + marginLeft - 20, footerY);

            // Save PDF with professional naming
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').split('T')[0];
            const cleanTitle = (formData.title || 'survey').replace(/[^a-zA-Z0-9]/g, '-').toLowerCase();
            const fileName = `${cleanTitle}-report-${timestamp}.pdf`;
            doc.save(fileName);

            // Show enhanced success message
            const successModal = `
‚úÖ Survey erfolgreich abgeschlossen!

üìÑ PDF-Report generiert: ${fileName}

üìä Zusammenfassung:
‚Ä¢ ${Object.keys(response.answers).length} Fragen beantwortet
‚Ä¢ ${Object.values(response.answers).reduce((total, answer) => 
    total + (answer.images ? answer.images.length : 0), 0)} Bilder enthalten
‚Ä¢ Professioneller PDF-Report erstellt

üîÑ Die Survey wurde zur√ºckgesetzt und ist bereit f√ºr die n√§chste Verwendung.
            `;
            
            alert(successModal);
        }

        function resetSurvey() {
            // Clear all form inputs
            formData.questions.forEach(question => {
                switch (question.type) {
                    case 'radio':
                        document.querySelectorAll(`input[name="answer_${question.id}"]`).forEach(input => input.checked = false);
                        break;
                    case 'checkbox':
                        document.querySelectorAll(`input[name="answer_${question.id}"]`).forEach(input => input.checked = false);
                        break;
                    case 'dropdown':
                        const dropdownInput = document.getElementById(`answer_${question.id}`);
                        if (dropdownInput) dropdownInput.selectedIndex = 0;
                        break;
                    default:
                        const input = document.getElementById(`answer_${question.id}`);
                        if (input) input.value = '';
                        break;
                }
                
                // Clear images
                if (question.imageCapture) {
                    question.images = [];
                    const imageContainer = document.getElementById(`imageContainer_${question.id}`);
                    if (imageContainer) imageContainer.innerHTML = '';
                    const imageCount = document.getElementById(`imageCount_${question.id}`);
                    if (imageCount) imageCount.textContent = '0 Bilder hinzugef√ºgt';
                }
            });

            // Clear responses array (but keep form definition)
            formData.responses = [];
        }
    </script>
</body>
</html>