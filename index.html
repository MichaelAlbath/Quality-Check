<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budni Survey Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            -webkit-text-size-adjust: 100%;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 10px;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            color: white;
            padding: 0 10px;
        }

        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 8px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .mode-selector {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            padding: 0 10px;
        }

        .mode-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            flex: 1;
            max-width: 200px;
            min-height: 44px; /* iOS touch target minimum */
        }

        .mode-btn.active {
            background: rgba(255,255,255,0.9);
            color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        .mode-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .main-content {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            margin: 0 5px;
        }

        .hidden {
            display: none;
        }

        /* Designer Mode Styles */
        .form-builder {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .sidebar {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 15px;
            order: 2;
        }

        .sidebar h3 {
            margin-bottom: 15px;
            color: #667eea;
            font-size: 1.2rem;
        }

        .question-types {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .question-type-btn {
            padding: 15px;
            border: 2px dashed #ddd;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 1rem;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .question-type-btn:hover {
            border-color: #667eea;
            background: #f0f4ff;
            transform: translateX(5px);
        }

        .form-preview {
            min-height: 300px;
            order: 1;
        }

        .survey-header {
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 15px;
            color: white;
        }

        .survey-header input {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 10px;
            background: rgba(255,255,255,0.9);
            min-height: 44px;
        }

        .survey-header textarea {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            resize: vertical;
            min-height: 80px;
            background: rgba(255,255,255,0.9);
            font-size: 1rem;
        }

        .question-item {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            position: relative;
        }

        .question-item:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .question-header {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }

        .question-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            min-height: 44px;
        }

        .question-controls {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .control-btn {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            min-height: 44px;
            min-width: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .control-btn.delete {
            background: #ff6b6b;
            color: white;
        }

        .control-btn.delete:hover {
            background: #ff5252;
            transform: scale(1.05);
        }

        .control-btn.move {
            background: #4ecdc4;
            color: white;
        }

        .control-btn.move:hover {
            background: #26a69a;
        }

        .options-container {
            margin-top: 15px;
        }

        .option-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .option-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            min-height: 44px;
            font-size: 1rem;
        }

        .add-option-btn {
            background: #67d4ed;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 44px;
            font-size: 1rem;
            flex: 1;
            margin-top: 10px;
        }

        .add-option-btn:hover {
            background: #4fc3d7;
            transform: scale(1.05);
        }

        .add-option-btn.file-load {
            background: #ff9800;
            flex: 0 0 auto;
            min-width: 140px;
        }

        .add-option-btn.file-load:hover {
            background: #f57c00;
        }

        .form-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 2px solid #eee;
        }

        .action-btn {
            padding: 15px 20px;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 50px;
            width: 100%;
        }

        .action-btn.primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .action-btn.secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        /* Survey Mode Styles */
        .survey-form {
            max-width: 100%;
            margin: 0 auto;
        }

        .survey-question {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border-left: 5px solid #667eea;
        }

        .survey-question h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.1rem;
            line-height: 1.4;
        }

        .survey-question input[type="text"],
        .survey-question textarea,
        .survey-question select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
            min-height: 44px;
            -webkit-appearance: none;
            background: white;
        }

        .survey-question input[type="text"]:focus,
        .survey-question textarea:focus,
        .survey-question select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .survey-question select {
            background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="%23666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6,9 12,15 18,9"></polyline></svg>');
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 16px;
            padding-right: 45px;
        }

        .survey-question textarea {
            resize: vertical;
            min-height: 100px;
        }

        .radio-group,
        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .option-label {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            min-height: 50px;
            border: 2px solid transparent;
        }

        .option-label:hover {
            background: #f0f4ff;
            border-color: #667eea;
        }

        .option-label input {
            margin: 0;
            transform: scale(1.2);
        }

        .option-label span {
            font-size: 1rem;
            line-height: 1.4;
        }

        .survey-navigation {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 30px;
        }

        .file-input {
            display: none;
        }

        .file-label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px 20px;
            background: #4ecdc4;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 44px;
            font-size: 1rem;
            text-align: center;
        }

        .file-label:hover {
            background: #26a69a;
            transform: scale(1.05);
        }

        .survey-list {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .survey-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
            min-height: 120px;
        }

        .survey-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            border-color: #667eea;
        }

        .survey-card h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .survey-card p {
            color: #666;
            margin-bottom: 15px;
            line-height: 1.4;
        }

        .survey-card .meta {
            font-size: 0.9rem;
            color: #999;
        }

        .survey-delete-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            z-index: 10;
            position: relative;
            min-width: 40px;
            min-height: 40px;
        }

        .survey-delete-btn:hover {
            background: #ff5252;
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(255, 107, 107, 0.4);
        }

        .survey-delete-btn:active {
            transform: scale(0.95);
        }

        /* Photo Upload Styles */
        .photo-upload-btn {
            color: white;
            padding: 8px 12px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            gap: 6px;
            min-height: 36px;
            text-decoration: none;
            border: none;
            justify-content: center;
            font-weight: 500;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        .photo-upload-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .photo-upload-btn:hover::before {
            left: 100%;
        }

        .photo-upload-btn.camera-btn {
            background: linear-gradient(135deg, #FF6B6B, #FF8E53);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .photo-upload-btn.camera-btn:hover {
            background: linear-gradient(135deg, #FF5252, #FF7043);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(255, 107, 107, 0.4);
        }

        .photo-upload-btn.camera-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);
        }

        .photo-upload-btn.gallery-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .photo-upload-btn.gallery-btn:hover {
            background: linear-gradient(135deg, #5a67d8, #6b46c1);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4);
        }

        .photo-upload-btn.gallery-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .photo-thumbnails {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .photo-thumbnail {
            position: relative;
            width: 80px;
            height: 80px;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #ddd;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .photo-thumbnail:hover {
            border-color: #667eea;
            transform: scale(1.05);
        }

        .photo-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-thumbnail .delete-photo {
            position: absolute;
            top: 2px;
            right: 2px;
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.9;
        }

        .photo-thumbnail .delete-photo:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        /* Photo Modal */
        .photo-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            backdrop-filter: blur(5px);
        }

        .photo-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .photo-modal-content {
            max-width: 90%;
            max-height: 90%;
            border-radius: 10px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .photo-modal img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 10px;
        }

        .photo-modal-close {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            z-index: 1001;
            transition: all 0.3s ease;
        }

        .photo-modal-close:hover {
            color: #ff4444;
            transform: scale(1.1);
        }

        /* Star Rating Styles */
        .star-rating {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 15px;
        }

        .star {
            font-size: 2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            filter: grayscale(100%);
            opacity: 0.4;
        }

        .star:hover,
        .star.active {
            filter: grayscale(0%);
            opacity: 1;
            transform: scale(1.1);
        }

        .star.active {
            text-shadow: 0 0 10px #ffeb3b;
        }

        /* Sonstiges Section Styles */
        .sonstiges-item {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            position: relative;
        }

        .sonstiges-item .delete-sonstiges {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .sonstiges-item .delete-sonstiges:hover {
            background: #ff5252;
            transform: scale(1.1);
        }

        .add-sonstiges-btn {
            background: #67d4ed;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 44px;
            font-size: 1rem;
            width: 100%;
            margin-top: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .add-sonstiges-btn:hover {
            background: #4fc3d7;
            transform: scale(1.02);
        }

        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .container {
                padding: 5px;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .mode-btn {
                font-size: 0.9rem;
                padding: 10px 15px;
            }
            
            .main-content {
                padding: 10px;
                margin: 0 2px;
                border-radius: 10px;
            }
            
            .form-builder {
                gap: 15px;
            }
            
            .sidebar {
                padding: 12px;
            }
            
            .question-item {
                padding: 12px;
            }
            
            .survey-question {
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .survey-question h3 {
                font-size: 1rem;
            }
            
            .photo-upload-btn {
                padding: 10px 14px;
                font-size: 0.9rem;
                min-height: 40px;
                border-radius: 10px;
            }
            
            .photo-thumbnails {
                justify-content: center;
            }
            
            .photo-thumbnail {
                width: 70px;
                height: 70px;
            }
            
            .photo-modal-close {
                top: 10px;
                right: 20px;
                font-size: 30px;
            }
            
            .star {
                font-size: 1.8rem;
            }
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 2px;
            }
            
            .header {
                margin-bottom: 15px;
            }
            
            .header h1 {
                font-size: 1.3rem;
                margin-bottom: 5px;
            }
            
            .mode-selector {
                gap: 8px;
                margin-bottom: 15px;
            }
            
            .mode-btn {
                font-size: 0.8rem;
                padding: 8px 12px;
            }
            
            .main-content {
                padding: 8px;
                border-radius: 8px;
            }
            
            .survey-header {
                padding: 15px;
                border-radius: 10px;
            }
            
            .survey-header input {
                font-size: 1rem;
                padding: 10px;
            }
            
            .question-item,
            .survey-question {
                padding: 10px;
                border-radius: 10px;
            }
            
            .question-controls {
                gap: 5px;
            }
            
            .control-btn {
                padding: 8px 10px;
                min-width: 40px;
                min-height: 40px;
                font-size: 0.9rem;
            }
            
            .option-label {
                padding: 12px;
                min-height: 44px;
            }
            
            .survey-card {
                padding: 15px;
                min-height: 100px;
            }
            
            .survey-delete-btn {
                width: 44px;
                height: 44px;
                font-size: 1.2rem;
                min-width: 44px;
                min-height: 44px;
            }
            
            .photo-upload-btn {
                padding: 12px 16px;
                font-size: 0.9rem;
                min-height: 44px;
                min-width: 100px;
                border-radius: 12px;
            }
            
            .photo-thumbnails {
                justify-content: flex-start;
            }
            
            .photo-thumbnail {
                width: 60px;
                height: 60px;
            }
            
            .photo-modal-content {
                max-width: 95%;
                max-height: 80%;
            }
            
            .photo-modal-close {
                top: 5px;
                right: 15px;
                font-size: 25px;
            }
            
            .star {
                font-size: 1.8rem;
            }
            
            .add-sonstiges-btn {
                padding: 15px;
                font-size: 1rem;
            }
            
            .sonstiges-item {
                padding: 12px;
            }
            
            .delete-sonstiges {
                width: 35px;
                height: 35px;
                font-size: 1.1rem;
            }
        }
        
        /* Desktop improvements */
        @media (min-width: 769px) {
            .container {
                max-width: 1200px;
                padding: 20px;
            }
            
            .form-builder {
                flex-direction: row;
                gap: 30px;
            }
            
            .sidebar {
                flex: 0 0 300px;
                order: 0;
                height: fit-content;
            }
            
            .form-preview {
                flex: 1;
                order: 1;
            }
            
            .form-actions {
                flex-direction: row;
                justify-content: center;
            }
            
            .action-btn {
                width: auto;
                min-width: 150px;
            }
            
            .survey-navigation {
                flex-direction: row;
                justify-content: center;
            }
            
            .survey-list {
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                gap: 20px;
            }
            
            .question-header {
                flex-direction: row;
                align-items: center;
            }
            
            .question-input {
                flex: 1;
            }
            
            .question-controls {
                margin-left: 15px;
                justify-content: flex-end;
            }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        let currentQuestionId = 0;
        let surveys = JSON.parse(localStorage.getItem('surveys') || '[]');
        let currentSurvey = null;
        let questionPhotos = {}; // Speichert Fotos f√ºr jede Frage
        let sonstigesCounter = 0; // Z√§hler f√ºr Sonstiges-Felder
        let debugMode = false; // Debug-Modus f√ºr iOS

        // iOS Debug System
        class IOSDebugger {
            constructor() {
                this.logs = [];
                this.debugPanel = null;
                this.isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                this.createDebugPanel();
            }

            createDebugPanel() {
                if (!this.isIOS) return;
                
                this.debugPanel = document.createElement('div');
                this.debugPanel.id = 'ios-debug-panel';
                this.debugPanel.style.cssText = `
                    position: fixed;
                    top: 10px;
                    right: 10px;
                    width: 300px;
                    max-height: 400px;
                    background: rgba(0,0,0,0.9);
                    color: #00ff00;
                    font-family: monospace;
                    font-size: 12px;
                    padding: 10px;
                    border-radius: 8px;
                    z-index: 10000;
                    overflow-y: auto;
                    display: none;
                `;
                
                const header = document.createElement('div');
                header.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <strong>iOS Debug Console</strong>
                        <button onclick="iosDebugger.toggle()" style="background: #ff4444; color: white; border: none; padding: 5px; border-radius: 3px;">√ó</button>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <button onclick="iosDebugger.clear()" style="background: #4444ff; color: white; border: none; padding: 5px; border-radius: 3px; margin-right: 5px;">Clear</button>
                        <button onclick="iosDebugger.testPDF()" style="background: #44ff44; color: black; border: none; padding: 5px; border-radius: 3px; margin-right: 5px;">Test PDF</button>
                        <button onclick="iosDebugger.testPhoto()" style="background: #ffff44; color: black; border: none; padding: 5px; border-radius: 3px;">Test Photo</button>
                    </div>
                    <div id="debug-content"></div>
                `;
                this.debugPanel.appendChild(header);
                document.body.appendChild(this.debugPanel);

                // Debug-Toggle Button hinzuf√ºgen
                const toggleBtn = document.createElement('button');
                toggleBtn.innerHTML = 'üêõ iOS Debug';
                toggleBtn.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    background: #ff9800;
                    color: white;
                    border: none;
                    padding: 10px;
                    border-radius: 50px;
                    z-index: 9999;
                    font-size: 12px;
                `;
                toggleBtn.onclick = () => this.toggle();
                document.body.appendChild(toggleBtn);
                
                // Memory Monitoring starten
                this.startMemoryMonitoring();
            }

            log(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = {
                    time: timestamp,
                    message: message,
                    type: type
                };
                
                this.logs.push(logEntry);
                
                // Normale Konsole auch verwenden
                console.log(`[iOS Debug ${timestamp}] ${message}`);
                
                // Debug Panel aktualisieren
                this.updatePanel();
                
                // Zu viele Logs? Alte entfernen
                if (this.logs.length > 50) {
                    this.logs = this.logs.slice(-30);
                }
            }

            error(message, error = null) {
                let errorMsg = message;
                if (error) {
                    errorMsg += ` | Error: ${error.message} | Stack: ${error.stack?.slice(0, 100)}`;
                }
                this.log(errorMsg, 'error');
            }

            updatePanel() {
                if (!this.debugPanel) return;
                
                const content = this.debugPanel.querySelector('#debug-content');
                if (!content) return;
                
                content.innerHTML = this.logs.map(log => {
                    const color = log.type === 'error' ? '#ff4444' : 
                                 log.type === 'warning' ? '#ffaa00' : '#00ff00';
                    return `<div style="color: ${color}; margin-bottom: 5px;">
                        [${log.time}] ${log.message}
                    </div>`;
                }).join('');
                
                content.scrollTop = content.scrollHeight;
            }

            toggle() {
                if (!this.debugPanel) return;
                
                const isVisible = this.debugPanel.style.display !== 'none';
                this.debugPanel.style.display = isVisible ? 'none' : 'block';
            }

            clear() {
                this.logs = [];
                this.updatePanel();
            }

            testPDF() {
                this.log('=== PDF Test Started ===');
                try {
                    const { jsPDF } = window.jspdf;
                    if (!jsPDF) {
                        throw new Error('jsPDF not available');
                    }
                    this.log('jsPDF available ‚úì');
                    
                    const doc = new jsPDF();
                    doc.text('Test PDF', 20, 20);
                    this.log('PDF created ‚úì');
                    
                    // Test speichern ohne Download
                    const pdfData = doc.output('blob');
                    this.log(`PDF blob created: ${Math.round(pdfData.size / 1024)}KB ‚úì`);
                    
                    this.log('PDF Test completed successfully!');
                } catch (error) {
                    this.error('PDF Test failed', error);
                }
            }

            testPhoto() {
                this.log('=== Photo Test Started ===');
                try {
                    // Test Canvas
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    if (!ctx) {
                        throw new Error('Canvas context not available');
                    }
                    this.log('Canvas available ‚úì');
                    
                    // Test Image
                    const img = new Image();
                    img.onload = () => {
                        this.log('Image load test ‚úì');
                        
                        // Test Compression
                        canvas.width = 100;
                        canvas.height = 100;
                        ctx.drawImage(img, 0, 0, 100, 100);
                        
                        const compressedData = canvas.toDataURL('image/jpeg', 0.2);
                        const sizeKB = Math.round(compressedData.length / 1024);
                        this.log(`Image compression test: ${sizeKB}KB ‚úì`);
                        
                        this.log('Photo Test completed successfully!');
                    };
                    
                    img.onerror = () => {
                        this.error('Image load test failed');
                    };
                    
                    // 1x1 Pixel Bild als Test
                    img.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==';
                    
                } catch (error) {
                    this.error('Photo Test failed', error);
                }
            }

            getMemoryInfo() {
                let info = [];
                
                if (window.performance && window.performance.memory) {
                    const memory = window.performance.memory;
                    info.push(`Memory: ${Math.round(memory.usedJSHeapSize / 1024 / 1024)}MB used`);
                    info.push(`${Math.round(memory.totalJSHeapSize / 1024 / 1024)}MB total`);
                    info.push(`${Math.round(memory.jsHeapSizeLimit / 1024 / 1024)}MB limit`);
                }
                
                if (navigator.deviceMemory) {
                    info.push(`Device: ${navigator.deviceMemory}GB RAM`);
                }
                
                if (navigator.hardwareConcurrency) {
                    info.push(`CPU cores: ${navigator.hardwareConcurrency}`);
                }
                
                return info.length > 0 ? info.join(' | ') : 'Memory info not available';
            }

            startMemoryMonitoring() {
                if (!this.isIOS) return;
                
                setInterval(() => {
                    if (window.performance && window.performance.memory) {
                        const memory = window.performance.memory;
                        const usedMB = Math.round(memory.usedJSHeapSize / 1024 / 1024);
                        const totalMB = Math.round(memory.totalJSHeapSize / 1024 / 1024);
                        
                        // Warnung bei hohem Memory-Verbrauch
                        if (usedMB > 100) {
                            this.log(`‚ö†Ô∏è High memory usage: ${usedMB}MB`, 'warning');
                        }
                    }
                }, 5000); // Alle 5 Sekunden
            }

            checkPhotoData(photos) {
                if (!photos || photos.length === 0) {
                    this.log('No photos to check');
                    return;
                }

                photos.forEach((photo, index) => {
                    const sizeKB = Math.round(photo.data.length / 1024);
                    this.log(`Photo ${index + 1}: ${sizeKB}KB, Format: ${photo.data.slice(5, 15)}`);
                });
            }
        }

        // iOS Debugger initialisieren
        const iosDebugger = new IOSDebugger();

        // Global Error Handler f√ºr iOS
        window.addEventListener('error', function(event) {
            iosDebugger.error('Global Error', {
                message: event.error?.message || event.message,
                filename: event.filename,
                lineno: event.lineno,
                colno: event.colno,
                stack: event.error?.stack
            });
        });

        window.addEventListener('unhandledrejection', function(event) {
            iosDebugger.error('Unhandled Promise Rejection', {
                reason: event.reason,
                promise: event.promise
            });
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            iosDebugger.log('App initialized');
            iosDebugger.log(`User Agent: ${navigator.userAgent}`);
            iosDebugger.log(`iOS detected: ${iosDebugger.isIOS}`);
            iosDebugger.log(`Screen: ${window.screen.width}x${window.screen.height}`);
            iosDebugger.log(`Viewport: ${window.innerWidth}x${window.innerHeight}`);
            iosDebugger.log(iosDebugger.getMemoryInfo());
            updateSurveyList();
            createPhotoModal();
        });

        function createPhotoModal() {
            const modal = document.createElement('div');
            modal.className = 'photo-modal';
            modal.id = 'photoModal';
            modal.innerHTML = `
                <span class="photo-modal-close" onclick="closePhotoModal()">&times;</span>
                <div class="photo-modal-content">
                    <img id="modalImage" src="" alt="Vergr√∂√üerte Ansicht">
                </div>
            `;
            document.body.appendChild(modal);

            // Close modal when clicking outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closePhotoModal();
                }
            });

            // Close modal with Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && modal.classList.contains('active')) {
                    closePhotoModal();
                }
            });
        }

        function handlePhotoUpload(questionId, event) {
            iosDebugger.log(`=== Photo Upload Started ===`);
            iosDebugger.log(`Question ID: ${questionId}`);
            iosDebugger.log(iosDebugger.getMemoryInfo());
            
            const files = event.target.files;
            if (!files.length) {
                iosDebugger.log('No files selected');
                return;
            }

            iosDebugger.log(`Files selected: ${files.length}`);

            if (!questionPhotos[questionId]) {
                questionPhotos[questionId] = [];
            }

            Array.from(files).forEach((file, index) => {
                iosDebugger.log(`Processing file ${index + 1}: ${file.name}, size: ${Math.round(file.size / 1024)}KB, type: ${file.type}`);
                
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        try {
                            iosDebugger.log(`File ${index + 1} loaded successfully`);
                            
                            const photoData = {
                                id: Date.now() + Math.random(),
                                data: e.target.result,
                                name: file.name
                            };
                            
                            const base64Size = Math.round(photoData.data.length / 1024);
                            iosDebugger.log(`File ${index + 1} converted to base64: ${base64Size}KB`);
                            
                            questionPhotos[questionId].push(photoData);
                            iosDebugger.log(`File ${index + 1} added to questionPhotos. Total for question ${questionId}: ${questionPhotos[questionId].length}`);
                            
                            updateThumbnails(questionId);
                            iosDebugger.log(`Thumbnails updated for question ${questionId}`);
                            iosDebugger.log(iosDebugger.getMemoryInfo());
                            
                        } catch (error) {
                            iosDebugger.error(`File ${index + 1} processing failed`, error);
                        }
                    };
                    
                    reader.onerror = function(error) {
                        iosDebugger.error(`File ${index + 1} reader error`, error);
                    };
                    
                    reader.readAsDataURL(file);
                } else {
                    iosDebugger.log(`File ${index + 1} skipped: not an image (${file.type})`);
                    alert('Bitte w√§hlen Sie nur Bilddateien aus.');
                }
            });

            // Reset input
            event.target.value = '';
            iosDebugger.log('File input reset');
        }

        function updateThumbnails(questionId) {
            const container = document.getElementById(`photoThumbnails${questionId}`);
            if (!container || !questionPhotos[questionId]) return;

            container.innerHTML = '';

            questionPhotos[questionId].forEach((photo, index) => {
                const thumbnail = document.createElement('div');
                thumbnail.className = 'photo-thumbnail';
                thumbnail.innerHTML = `
                    <img src="${photo.data}" alt="${photo.name}" onclick="openPhotoModal('${photo.data}')">
                    <button class="delete-photo" onclick="deletePhoto(${questionId}, ${index})" title="Foto l√∂schen">√ó</button>
                `;
                container.appendChild(thumbnail);
            });
        }

        function deletePhoto(questionId, photoIndex) {
            if (confirm('M√∂chten Sie dieses Foto wirklich l√∂schen?')) {
                questionPhotos[questionId].splice(photoIndex, 1);
                updateThumbnails(questionId);
            }
        }

        function openPhotoModal(imageSrc) {
            const modal = document.getElementById('photoModal');
            const modalImage = document.getElementById('modalImage');
            modalImage.src = imageSrc;
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closePhotoModal() {
            const modal = document.getElementById('photoModal');
            modal.classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        // Star Rating Functions
        function setRating(questionId, rating) {
            const starContainer = document.querySelector(`[data-question="${questionId}"]`);
            const stars = starContainer.querySelectorAll('.star');
            const hiddenInput = document.getElementById(`rating${questionId}`);
            const ratingText = starContainer.querySelector('.rating-text');
            
            // Reset all stars
            stars.forEach(star => star.classList.remove('active'));
            
            // Activate stars up to selected rating
            for (let i = 0; i < rating; i++) {
                stars[i].classList.add('active');
            }
            
            // Update hidden input value
            hiddenInput.value = rating;
            
            // Update text
            const ratingTexts = ['', 'Sehr schlecht', 'Schlecht', 'Okay', 'Gut', 'Sehr gut'];
            ratingText.textContent = `Ihre Bewertung: ${rating}/5 - ${ratingTexts[rating]}`;
        }

        // Sonstiges Field Functions
        function addSonstigesField() {
            sonstigesCounter++;
            const container = document.getElementById('sonstigesContainer');
            const newField = document.createElement('div');
            newField.className = 'sonstiges-item';
            newField.dataset.index = sonstigesCounter;
            
            newField.innerHTML = `
                <button type="button" class="delete-sonstiges" onclick="deleteSonstigesField(${sonstigesCounter})" title="Feld entfernen">√ó</button>
                <textarea name="sonstiges_${sonstigesCounter}" placeholder="Weitere Anmerkung..." style="width: 100%; padding: 15px; border: 2px solid #e1e8ed; border-radius: 8px; font-size: 1rem; min-height: 100px; resize: vertical; -webkit-appearance: none; background: white;"></textarea>
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                        <label for="photoCameraSonstiges${sonstigesCounter}" class="photo-upload-btn camera-btn">
                            üì∑ Kamera
                        </label>
                        <input type="file" id="photoCameraSonstiges${sonstigesCounter}" accept="image/*" capture="environment" multiple style="display: none;" onchange="handlePhotoUpload('sonstiges_${sonstigesCounter}', event)">
                        
                        <label for="photoGallerySonstiges${sonstigesCounter}" class="photo-upload-btn gallery-btn">
                            üñºÔ∏è Galerie
                        </label>
                        <input type="file" id="photoGallerySonstiges${sonstigesCounter}" accept="image/*" multiple style="display: none;" onchange="handlePhotoUpload('sonstiges_${sonstigesCounter}', event)">
                    </div>
                    <div id="photoThumbnailssonstiges_${sonstigesCounter}" class="photo-thumbnails"></div>
                </div>
            `;
            
            container.appendChild(newField);
        }

        function deleteSonstigesField(index) {
            // Das erste Feld (Index 0) soll nicht gel√∂scht werden k√∂nnen
            if (index === 0) {
                alert('Das erste Anmerkungsfeld kann nicht entfernt werden.');
                return;
            }
            
            if (confirm('M√∂chten Sie dieses Anmerkungsfeld wirklich entfernen?')) {
                const field = document.querySelector(`[data-index="${index}"]`);
                if (field) {
                    // Fotos aus dem questionPhotos-Objekt entfernen
                    delete questionPhotos[`sonstiges_${index}`];
                    field.remove();
                }
            }
        }

        function switchMode(mode) {
            // Passwort-Schutz f√ºr Designer-Modus
            if (mode === 'designer') {
                const password = prompt('Bitte geben Sie das Passwort f√ºr den Designer-Modus ein:');
                if (password !== '1508') {
                    alert('Falsches Passwort! Zugriff verweigert.');
                    return;
                }
            }

            // Update button states
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Show/hide content
            if (mode === 'designer') {
                document.getElementById('designer-mode').classList.remove('hidden');
                document.getElementById('survey-mode').classList.add('hidden');
            } else {
                document.getElementById('designer-mode').classList.add('hidden');
                document.getElementById('survey-mode').classList.remove('hidden');
                
                // Wenn eine Umfrage ge√∂ffnet ist, zur√ºck zur Auswahl gehen
                if (!document.getElementById('survey-form-container').classList.contains('hidden')) {
                    backToSurveyList();
                } else {
                    updateSurveyList();
                }
            }
        }

        function addQuestion(type) {
            currentQuestionId++;
            const container = document.getElementById('questionsContainer');
            const questionDiv = document.createElement('div');
            questionDiv.className = 'question-item';
            questionDiv.dataset.id = currentQuestionId;
            questionDiv.dataset.type = type;

            let questionHTML = `
                <div class="question-header">
                    <input type="text" class="question-input" placeholder="Ihre Frage hier..." onchange="updateQuestion(${currentQuestionId})">
                    <div class="question-controls">
                        <button type="button" class="control-btn move" onclick="moveQuestion(${currentQuestionId}, -1)">‚Üë</button>
                        <button type="button" class="control-btn move" onclick="moveQuestion(${currentQuestionId}, 1)">‚Üì</button>
                        <button type="button" class="control-btn delete" onclick="deleteQuestion(${currentQuestionId})">üóëÔ∏è</button>
                    </div>
                </div>
            `;

            if (type === 'text') {
                questionHTML += '<input type="text" placeholder="Antwort..." disabled style="margin-top: 10px; width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">';
            } else if (type === 'textarea') {
                questionHTML += '<textarea placeholder="Antwort..." disabled style="margin-top: 10px; width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; min-height: 80px; resize: vertical;"></textarea>';
            } else if (type === 'radio' || type === 'checkbox' || type === 'dropdown') {
                questionHTML += `
                    <div class="options-container">
                        <div class="option-item">
                            <input type="${type === 'dropdown' ? 'text' : type}" disabled>
                            <input type="text" class="option-input" placeholder="Option 1" onchange="updateQuestion(${currentQuestionId})">
                            <button type="button" class="control-btn delete" onclick="removeOption(this)">√ó</button>
                        </div>
                        <div class="option-item">
                            <input type="${type === 'dropdown' ? 'text' : type}" disabled>
                            <input type="text" class="option-input" placeholder="Option 2" onchange="updateQuestion(${currentQuestionId})">
                            <button type="button" class="control-btn delete" onclick="removeOption(this)">√ó</button>
                        </div>
                        <div style="display: flex; gap: 5px; margin-top: 10px;">
                            <button type="button" class="add-option-btn" onclick="addOption(${currentQuestionId}, '${type}')">+ Option hinzuf√ºgen</button>
                            ${type === 'dropdown' ? `<input type="file" id="textFile${currentQuestionId}" accept=".txt" style="display: none;" onchange="loadOptionsFromFile(${currentQuestionId}, event)">
                            <button type="button" class="add-option-btn file-load" onclick="document.getElementById('textFile${currentQuestionId}').click()">üìÅ Aus Datei</button>` : ''}
                        </div>
                    </div>
                `;
            } else if (type === 'rating') {
                questionHTML += `
                    <div style="margin-top: 10px;">
                        <div style="display: flex; gap: 5px; align-items: center;">
                            <span style="filter: grayscale(100%); opacity: 0.4; font-size: 1.5rem;">‚≠ê</span>
                            <span style="filter: grayscale(100%); opacity: 0.4; font-size: 1.5rem;">‚≠ê</span>
                            <span style="filter: grayscale(100%); opacity: 0.4; font-size: 1.5rem;">‚≠ê</span>
                            <span style="filter: grayscale(100%); opacity: 0.4; font-size: 1.5rem;">‚≠ê</span>
                            <span style="filter: grayscale(100%); opacity: 0.4; font-size: 1.5rem;">‚≠ê</span>
                        </div>
                        <div style="margin-top: 5px; font-size: 0.9rem; color: #666;">Bewertung von 1-5 Sternen</div>
                    </div>
                `;
            }

            questionDiv.innerHTML = questionHTML;
            container.appendChild(questionDiv);
        }

        function deleteQuestion(id) {
            const question = document.querySelector(`[data-id="${id}"]`);
            if (question && confirm('M√∂chten Sie diese Frage wirklich l√∂schen?')) {
                question.remove();
            }
        }

        function moveQuestion(id, direction) {
            const question = document.querySelector(`[data-id="${id}"]`);
            const container = document.getElementById('questionsContainer');
            const questions = Array.from(container.children);
            const currentIndex = questions.indexOf(question);
            const newIndex = currentIndex + direction;

            if (newIndex >= 0 && newIndex < questions.length) {
                if (direction === -1) {
                    container.insertBefore(question, questions[newIndex]);
                } else {
                    container.insertBefore(question, questions[newIndex].nextSibling);
                }
            }
        }

        function addOption(questionId, type) {
            const question = document.querySelector(`[data-id="${questionId}"]`);
            const optionsContainer = question.querySelector('.options-container');
            const addButton = optionsContainer.querySelector('.add-option-btn');
            const optionCount = optionsContainer.querySelectorAll('.option-item').length + 1;

            const optionDiv = document.createElement('div');
            optionDiv.className = 'option-item';
            optionDiv.innerHTML = `
                <input type="${type === 'dropdown' ? 'text' : type}" disabled>
                <input type="text" class="option-input" placeholder="Option ${optionCount}" onchange="updateQuestion(${questionId})">
                <button type="button" class="control-btn delete" onclick="removeOption(this)">√ó</button>
            `;

            optionsContainer.insertBefore(optionDiv, addButton.parentElement);
        }

        function loadOptionsFromFile(questionId, event) {
            const file = event.target.files[0];
            if (file && file.type === 'text/plain') {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const text = e.target.result;
                        const lines = text.split('\n').map(line => line.trim()).filter(line => line.length > 0);
                        
                        if (lines.length === 0) {
                            alert('Die Textdatei ist leer oder enth√§lt keine g√ºltigen Optionen.');
                            return;
                        }

                        const question = document.querySelector(`[data-id="${questionId}"]`);
                        const optionsContainer = question.querySelector('.options-container');
                        const questionType = question.dataset.type;
                        
                        // Alle bestehenden Optionen entfernen
                        const existingOptions = optionsContainer.querySelectorAll('.option-item');
                        existingOptions.forEach(option => option.remove());

                        // Button-Container finden oder erstellen
                        let buttonsContainer = optionsContainer.querySelector('div[style*="display: flex"]');
                        
                        // Neue Optionen aus Datei hinzuf√ºgen - genau so viele wie Zeilen in der Datei
                        lines.forEach((line, index) => {
                            const optionDiv = document.createElement('div');
                            optionDiv.className = 'option-item';
                            optionDiv.innerHTML = `
                                <input type="${questionType === 'dropdown' ? 'text' : questionType}" disabled>
                                <input type="text" class="option-input" placeholder="Option ${index + 1}" value="${line}" onchange="updateQuestion(${questionId})">
                                <button type="button" class="control-btn delete" onclick="removeOption(this)">√ó</button>
                            `;
                            
                            // Option vor dem Button-Container einf√ºgen
                            optionsContainer.insertBefore(optionDiv, buttonsContainer);
                        });

                        alert(`${lines.length} Optionen wurden erfolgreich aus der Datei geladen!`);
                        
                    } catch (error) {
                        alert('Fehler beim Laden der Datei: ' + error.message);
                    }
                };
                reader.readAsText(file, 'UTF-8');
            } else {
                alert('Bitte w√§hlen Sie eine g√ºltige Textdatei (.txt) aus.');
            }
            
            // Input zur√ºcksetzen, damit dieselbe Datei erneut geladen werden kann
            event.target.value = '';
        }

        function removeOption(button) {
            const optionItem = button.parentElement;
            const optionsContainer = optionItem.parentElement;
            if (optionsContainer.querySelectorAll('.option-item').length > 2) {
                optionItem.remove();
            } else {
                alert('Eine Frage muss mindestens 2 Optionen haben.');
            }
        }

        function updateQuestion(id) {
            // This function can be used to handle real-time updates if needed
        }

        function saveSurvey() {
            const survey = {
                id: Date.now(),
                title: document.getElementById('surveyTitle').value || 'Unbenannte Umfrage',
                description: document.getElementById('surveyDescription').value || '',
                created: new Date().toLocaleDateString('de-DE'),
                questions: []
            };

            const questions = document.querySelectorAll('.question-item');
            questions.forEach(questionEl => {
                const question = {
                    id: questionEl.dataset.id,
                    type: questionEl.dataset.type,
                    text: questionEl.querySelector('.question-input').value || 'Unbenannte Frage',
                    options: []
                };

                if (questionEl.dataset.type === 'radio' || questionEl.dataset.type === 'checkbox' || questionEl.dataset.type === 'dropdown') {
                    const optionInputs = questionEl.querySelectorAll('.option-input');
                    optionInputs.forEach(input => {
                        if (input.value.trim()) {
                            question.options.push(input.value.trim());
                        }
                    });
                }

                survey.questions.push(question);
            });

            surveys.push(survey);
            localStorage.setItem('surveys', JSON.stringify(surveys));

            // Download as JSON file
            const dataStr = JSON.stringify(survey, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const exportFileDefaultName = `${survey.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.json`;

            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();

            alert('Umfrage wurde gespeichert und heruntergeladen!');
        }

        function loadSurvey(event) {
            const file = event.target.files[0];
            if (file && file.type === 'application/json') {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const survey = JSON.parse(e.target.result);
                        loadSurveyData(survey);
                        
                        // Umfrage zu verf√ºgbaren Umfragen hinzuf√ºgen
                        if (!survey.id) {
                            survey.id = Date.now();
                        }
                        if (!survey.created) {
                            survey.created = new Date().toLocaleDateString('de-DE');
                        }
                        
                        // Pr√ºfe ob Umfrage bereits existiert
                        const existingIndex = surveys.findIndex(s => s.title === survey.title);
                        if (existingIndex !== -1) {
                            surveys[existingIndex] = survey;
                        } else {
                            surveys.push(survey);
                        }
                        
                        localStorage.setItem('surveys', JSON.stringify(surveys));
                        updateSurveyList();
                        
                        alert('Umfrage wurde erfolgreich geladen und ist jetzt verf√ºgbar!');
                    } catch (error) {
                        alert('Fehler beim Laden der Datei: ' + error.message);
                    }
                };
                reader.readAsText(file);
            }
        }

        function loadSurveyData(survey) {
            document.getElementById('surveyTitle').value = survey.title || '';
            document.getElementById('surveyDescription').value = survey.description || '';
            
            // Clear existing questions
            document.getElementById('questionsContainer').innerHTML = '';
            currentQuestionId = 0;

            // Load questions
            survey.questions.forEach(question => {
                addQuestion(question.type);
                const questionEl = document.querySelector(`[data-id="${currentQuestionId}"]`);
                questionEl.querySelector('.question-input').value = question.text;

                if (question.options && question.options.length > 0) {
                    const optionsContainer = questionEl.querySelector('.options-container');
                    const existingOptions = optionsContainer.querySelectorAll('.option-item');
                    
                    // Remove all existing options
                    existingOptions.forEach(option => option.remove());

                    // Find the buttons container
                    const buttonsContainer = optionsContainer.querySelector('div[style*="display: flex"]');

                    // Add exact number of options as in the saved data
                    question.options.forEach((optionText, index) => {
                        const optionDiv = document.createElement('div');
                        optionDiv.className = 'option-item';
                        optionDiv.innerHTML = `
                            <input type="${question.type === 'dropdown' ? 'text' : question.type}" disabled>
                            <input type="text" class="option-input" placeholder="Option ${index + 1}" value="${optionText}" onchange="updateQuestion(${currentQuestionId})">
                            <button type="button" class="control-btn delete" onclick="removeOption(this)">√ó</button>
                        `;
                        optionsContainer.insertBefore(optionDiv, buttonsContainer);
                    });
                }
            });
        }

        function clearSurvey() {
            if (confirm('M√∂chten Sie wirklich alle Fragen l√∂schen?')) {
                document.getElementById('questionsContainer').innerHTML = '';
                document.getElementById('surveyTitle').value = 'Meine Umfrage';
                document.getElementById('surveyDescription').value = 'Vielen Dank f√ºr Ihre Teilnahme an unserer Umfrage!';
                currentQuestionId = 0;
            }
        }

        function previewSurvey() {
            const survey = getCurrentSurveyData();
            if (survey.questions.length === 0) {
                alert('Bitte f√ºgen Sie mindestens eine Frage hinzu.');
                return;
            }
            
            currentSurvey = survey;
            switchMode('survey');
            showSurvey(survey);
        }

        function getCurrentSurveyData() {
            const survey = {
                title: document.getElementById('surveyTitle').value || 'Unbenannte Umfrage',
                description: document.getElementById('surveyDescription').value || '',
                questions: []
            };

            const questions = document.querySelectorAll('.question-item');
            questions.forEach(questionEl => {
                const question = {
                    id: questionEl.dataset.id,
                    type: questionEl.dataset.type,
                    text: questionEl.querySelector('.question-input').value || 'Unbenannte Frage',
                    options: []
                };

                if (questionEl.dataset.type === 'radio' || questionEl.dataset.type === 'checkbox' || questionEl.dataset.type === 'dropdown') {
                    const optionInputs = questionEl.querySelectorAll('.option-input');
                    optionInputs.forEach(input => {
                        if (input.value.trim()) {
                            question.options.push(input.value.trim());
                        }
                    });
                }

                survey.questions.push(question);
            });

            return survey;
        }

        function generateSurveyLink() {
            const survey = getCurrentSurveyData();
            if (survey.questions.length === 0) {
                alert('Bitte f√ºgen Sie mindestens eine Frage hinzu.');
                return;
            }

            // Save to local storage for sharing
            const surveyId = Date.now();
            survey.id = surveyId;
            surveys.push(survey);
            localStorage.setItem('surveys', JSON.stringify(surveys));

            const currentUrl = window.location.href.split('?')[0];
            const surveyUrl = `${currentUrl}?survey=${surveyId}`;
            
            // Copy to clipboard
            navigator.clipboard.writeText(surveyUrl).then(() => {
                alert(`Umfrage-Link wurde in die Zwischenablage kopiert!\n\nLink: ${surveyUrl}`);
            }).catch(() => {
                prompt('Kopieren Sie diesen Link:', surveyUrl);
            });
        }

        function updateSurveyList() {
            const surveyList = document.getElementById('surveyList');
            surveyList.innerHTML = '';

            if (surveys.length === 0) {
                surveyList.innerHTML = '<p style="text-align: center; color: #666; grid-column: 1/-1;">Keine Umfragen verf√ºgbar. Erstellen Sie eine Umfrage im Designer-Modus.</p>';
                return;
            }

            surveys.forEach((survey, index) => {
                const surveyCard = document.createElement('div');
                surveyCard.className = 'survey-card';
                surveyCard.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                        <h3 style="margin: 0; flex: 1;">${survey.title}</h3>
                        <button class="survey-delete-btn" onclick="event.stopPropagation(); deleteSurvey(${index})" title="Umfrage l√∂schen">üóëÔ∏è</button>
                    </div>
                    <p>${survey.description}</p>
                    <div class="meta">
                        ${survey.questions.length} Fragen ‚Ä¢ Erstellt: ${survey.created || 'Unbekannt'}
                    </div>
                `;
                
                // Make the whole card clickable
                surveyCard.onclick = () => showSurvey(survey);
                surveyList.appendChild(surveyCard);
            });
        }

        function deleteSurvey(index) {
            // Passwort-Abfrage vor dem L√∂schen
            const password = prompt('Bitte geben Sie das Passwort zum L√∂schen ein:');
            if (password !== '1508') {
                alert('Falsches Passwort! L√∂schen nicht m√∂glich.');
                return;
            }

            const survey = surveys[index];
            if (confirm(`M√∂chten Sie die Umfrage "${survey.title}" wirklich unwiderruflich l√∂schen?`)) {
                // Survey aus Array entfernen
                surveys.splice(index, 1);
                
                // localStorage aktualisieren
                localStorage.setItem('surveys', JSON.stringify(surveys));
                
                // Auch zugeh√∂rige Antworten l√∂schen
                let savedResponses = JSON.parse(localStorage.getItem('surveyResponses') || '[]');
                savedResponses = savedResponses.filter(response => response.surveyId !== survey.id);
                localStorage.setItem('surveyResponses', JSON.stringify(savedResponses));
                
                // Liste neu laden
                updateSurveyList();
                
                alert('Umfrage wurde erfolgreich gel√∂scht.');
            }
        }

        function showSurvey(survey) {
            currentSurvey = survey;
            questionPhotos = {}; // Reset photos when starting new survey
            sonstigesCounter = 0; // Reset sonstiges counter
            
            document.getElementById('survey-selection').classList.add('hidden');
            document.getElementById('survey-form-container').classList.remove('hidden');

            document.getElementById('currentSurveyTitle').textContent = survey.title;
            document.getElementById('currentSurveyDescription').textContent = survey.description;

            const questionsContainer = document.getElementById('surveyQuestions');
            questionsContainer.innerHTML = '';

            survey.questions.forEach((question, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'survey-question';

                let questionHTML = `<h3>${question.text}</h3>`;

                if (question.type === 'text') {
                    questionHTML += `<input type="text" name="q${question.id}" placeholder="Ihre Antwort...">`;
                } else if (question.type === 'textarea') {
                    questionHTML += `<textarea name="q${question.id}" placeholder="Ihre Antwort..."></textarea>`;
                } else if (question.type === 'radio') {
                    questionHTML += '<div class="radio-group">';
                    question.options.forEach((option, optIndex) => {
                        questionHTML += `
                            <label class="option-label">
                                <input type="radio" name="q${question.id}" value="${option}">
                                <span>${option}</span>
                            </label>
                        `;
                    });
                    questionHTML += '</div>';
                } else if (question.type === 'checkbox') {
                    questionHTML += '<div class="checkbox-group">';
                    question.options.forEach((option, optIndex) => {
                        questionHTML += `
                            <label class="option-label">
                                <input type="checkbox" name="q${question.id}" value="${option}">
                                <span>${option}</span>
                            </label>
                        `;
                    });
                    questionHTML += '</div>';
                } else if (question.type === 'dropdown') {
                    questionHTML += `
                        <select name="q${question.id}" style="width: 100%; padding: 15px; border: 2px solid #e1e8ed; border-radius: 8px; font-size: 1rem; min-height: 44px; -webkit-appearance: none; background: white;">
                            <option value="">Bitte w√§hlen Sie...</option>
                    `;
                    question.options.forEach((option, optIndex) => {
                        if (option && option.trim()) {  // Nur nicht-leere Optionen anzeigen
                            questionHTML += `<option value="${option}">${option}</option>`;
                        }
                    });
                    questionHTML += '</select>';
                } else if (question.type === 'rating') {
                    questionHTML += `
                        <div class="star-rating" data-question="${question.id}">
                            <span class="star" data-rating="1" onclick="setRating(${question.id}, 1)">‚≠ê</span>
                            <span class="star" data-rating="2" onclick="setRating(${question.id}, 2)">‚≠ê</span>
                            <span class="star" data-rating="3" onclick="setRating(${question.id}, 3)">‚≠ê</span>
                            <span class="star" data-rating="4" onclick="setRating(${question.id}, 4)">‚≠ê</span>
                            <span class="star" data-rating="5" onclick="setRating(${question.id}, 5)">‚≠ê</span>
                            <input type="hidden" name="q${question.id}" id="rating${question.id}" value="">
                            <div class="rating-text" style="margin-top: 10px; font-size: 0.9rem; color: #666;">
                                Bitte w√§hlen Sie eine Bewertung
                            </div>
                        </div>
                    `;
                }

                // Foto-Upload-Sektion f√ºr jede Frage hinzuf√ºgen
                questionHTML += `
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                            <label for="photoCamera${question.id}" class="photo-upload-btn camera-btn">
                                üì∑ Kamera
                            </label>
                            <input type="file" id="photoCamera${question.id}" accept="image/*" capture="environment" multiple style="display: none;" onchange="handlePhotoUpload(${question.id}, event)">
                            
                            <label for="photoGallery${question.id}" class="photo-upload-btn gallery-btn">
                                üñºÔ∏è Galerie
                            </label>
                            <input type="file" id="photoGallery${question.id}" accept="image/*" multiple style="display: none;" onchange="handlePhotoUpload(${question.id}, event)">
                        </div>
                        <div id="photoThumbnails${question.id}" class="photo-thumbnails"></div>
                    </div>
                `;

                questionDiv.innerHTML = questionHTML;
                questionsContainer.appendChild(questionDiv);
            });

            // Sonstiges-Sektion am Ende hinzuf√ºgen
            const sonstigesSection = document.createElement('div');
            sonstigesSection.className = 'survey-question';
            sonstigesSection.id = 'sonstigesSection';
            sonstigesSection.innerHTML = `
                <h3>üìù Sonstiges / Zus√§tzliche Anmerkungen</h3>
                <div id="sonstigesContainer">
                    <div class="sonstiges-item" data-index="0">
                        <textarea name="sonstiges_0" placeholder="Ihre zus√§tzlichen Anmerkungen..." style="width: 100%; padding: 15px; border: 2px solid #e1e8ed; border-radius: 8px; font-size: 1rem; min-height: 100px; resize: vertical; -webkit-appearance: none; background: white;"></textarea>
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                                <label for="photoCameraSonstiges0" class="photo-upload-btn camera-btn">
                                    üì∑ Kamera
                                </label>
                                <input type="file" id="photoCameraSonstiges0" accept="image/*" capture="environment" multiple style="display: none;" onchange="handlePhotoUpload('sonstiges_0', event)">
                                
                                <label for="photoGallerySonstiges0" class="photo-upload-btn gallery-btn">
                                    üñºÔ∏è Galerie
                                </label>
                                <input type="file" id="photoGallerySonstiges0" accept="image/*" multiple style="display: none;" onchange="handlePhotoUpload('sonstiges_0', event)">
                            </div>
                            <div id="photoThumbnailssonstiges_0" class="photo-thumbnails"></div>
                        </div>
                    </div>
                </div>
                <button type="button" class="add-sonstiges-btn" onclick="addSonstigesField()">
                    ‚ûï Weitere Anmerkung hinzuf√ºgen
                </button>
            `;
            questionsContainer.appendChild(sonstigesSection);

            // Handle form submission
            document.getElementById('surveyForm').onsubmit = function(e) {
                e.preventDefault();
                
                // Antworten sammeln und PDF generieren
                generateSurveyPDF(survey);
            };
        }

        function backToSurveyList() {
            document.getElementById('survey-selection').classList.remove('hidden');
            document.getElementById('survey-form-container').classList.add('hidden');
            currentSurvey = null;
            questionPhotos = {}; // Reset photos when going back
            sonstigesCounter = 0; // Reset sonstiges counter
        }

        // Check for survey URL parameter on load
        window.addEventListener('load', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const surveyId = urlParams.get('survey');
            
            if (surveyId) {
                const survey = surveys.find(s => s.id == surveyId);
                if (survey) {
                    switchMode('survey');
                    showSurvey(survey);
                } else {
                    alert('Umfrage nicht gefunden.');
                }
            }
        });

        // PDF Generation Function mit Debug
        async function generateSurveyPDF(survey) {
            iosDebugger.log('=== PDF Generation Started ===');
            iosDebugger.log(`Survey: ${survey.title}`);
            iosDebugger.log(iosDebugger.getMemoryInfo());
            
            try {
                // Sammle alle Antworten
                iosDebugger.log('Collecting form data...');
                const formData = new FormData(document.getElementById('surveyForm'));
                const responses = {};

                // Collect all responses
                for (let [key, value] of formData.entries()) {
                    if (responses[key]) {
                        if (Array.isArray(responses[key])) {
                            responses[key].push(value);
                        } else {
                            responses[key] = [responses[key], value];
                        }
                    } else {
                        responses[key] = value;
                    }
                }

                iosDebugger.log(`Responses collected: ${Object.keys(responses).length} items`);

                // Speichere auch im localStorage
                iosDebugger.log('Saving to localStorage...');
                const responseData = {
                    surveyId: survey.id,
                    surveyTitle: survey.title,
                    responses: responses,
                    photos: questionPhotos,
                    timestamp: new Date().toISOString()
                };

                let savedResponses = JSON.parse(localStorage.getItem('surveyResponses') || '[]');
                savedResponses.push(responseData);
                localStorage.setItem('surveyResponses', JSON.stringify(savedResponses));
                iosDebugger.log('localStorage save successful');

                // Photo analysis
                const totalPhotos = Object.values(questionPhotos).reduce((sum, photos) => sum + (photos ? photos.length : 0), 0);
                iosDebugger.log(`Total photos: ${totalPhotos}`);
                
                Object.keys(questionPhotos).forEach(key => {
                    if (questionPhotos[key]) {
                        iosDebugger.log(`Question ${key}: ${questionPhotos[key].length} photos`);
                        iosDebugger.checkPhotoData(questionPhotos[key]);
                    }
                });

                // iOS Safari Detection
                const isIOSSafari = /iPad|iPhone|iPod/.test(navigator.userAgent) && /Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent);
                iosDebugger.log(`iOS Safari detected: ${isIOSSafari}`);

                if (isIOSSafari) {
                    iosDebugger.log('Using iOS-optimized PDF generation');
                    await generateSimplifiedPDF(survey, responses);
                } else {
                    iosDebugger.log('Using full PDF generation');
                    await generateFullPDF(survey, responses);
                }

            } catch (error) {
                iosDebugger.error('PDF Generation failed', error);
                iosDebugger.log(iosDebugger.getMemoryInfo());
                alert(`PDF-Fehler: ${error.message}\n\nCheck Debug-Panel f√ºr Details`);
                
                // Fallback: Normale Speicherung
                questionPhotos = {};
                sonstigesCounter = 0;
                backToSurveyList();
            }
        }

        // Simplified PDF for iOS Safari mit Debug
        async function generateSimplifiedPDF(survey, responses) {
            iosDebugger.log('=== iOS PDF Generation ===');
            
            try {
                iosDebugger.log('Initializing jsPDF...');
                const { jsPDF } = window.jspdf;
                if (!jsPDF) {
                    throw new Error('jsPDF not loaded');
                }
                
                const doc = new jsPDF();
                iosDebugger.log('jsPDF initialized successfully');
                
                let yPosition = 30;
                const pageHeight = doc.internal.pageSize.height;
                const pageWidth = doc.internal.pageSize.width;
                const margin = 20;
                const maxWidth = pageWidth - 2 * margin;

                iosDebugger.log(`Page dimensions: ${pageWidth}x${pageHeight}`);

                // Simple Header
                iosDebugger.log('Adding header...');
                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                doc.text('BUDNI SURVEY TOOL', margin, yPosition);
                yPosition += 10;
                
                doc.setFontSize(14);
                doc.text(survey.title, margin, yPosition);
                yPosition += 15;

                // Date
                doc.setFontSize(10);
                doc.text(`Ausgef√ºllt am: ${new Date().toLocaleDateString('de-DE')}`, margin, yPosition);
                yPosition += 20;

                iosDebugger.log('Header added successfully');

                // iOS-optimierte Bildkomprimierung mit Debug
                function compressImageForIOS(base64Data, index = 0) {
                    return new Promise((resolve) => {
                        iosDebugger.log(`Compressing image ${index + 1}...`);
                        
                        try {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            const img = new Image();
                            
                            const startTime = Date.now();
                            
                            img.onload = function() {
                                try {
                                    iosDebugger.log(`Image ${index + 1} loaded: ${img.width}x${img.height}`);
                                    
                                    // Ultra-aggressive Komprimierung f√ºr mehr Bilder
                                    const maxSize = 100;
                                    const aspectRatio = img.width / img.height;
                                    
                                    let newWidth = Math.min(img.width, maxSize);
                                    let newHeight = newWidth / aspectRatio;
                                    
                                    if (newHeight > maxSize) {
                                        newHeight = maxSize;
                                        newWidth = maxSize * aspectRatio;
                                    }
                                    
                                    canvas.width = newWidth;
                                    canvas.height = newHeight;
                                    
                                    iosDebugger.log(`Image ${index + 1} resized to: ${newWidth}x${newHeight}`);
                                    
                                    ctx.drawImage(img, 0, 0, newWidth, newHeight);
                                    
                                    // Ultra-niedrige Qualit√§t f√ºr iOS
                                    const compressedData = canvas.toDataURL('image/jpeg', 0.2);
                                    const compressionTime = Date.now() - startTime;
                                    const originalSize = Math.round(base64Data.length / 1024);
                                    const compressedSize = Math.round(compressedData.length / 1024);
                                    
                                    iosDebugger.log(`Image ${index + 1} compressed: ${originalSize}KB ‚Üí ${compressedSize}KB in ${compressionTime}ms`);
                                    
                                    resolve(compressedData);
                                } catch (canvasError) {
                                    iosDebugger.error(`Canvas error for image ${index + 1}`, canvasError);
                                    resolve(null);
                                }
                            };
                            
                            img.onerror = function(imgError) {
                                iosDebugger.error(`Image ${index + 1} load failed`, imgError);
                                resolve(null);
                            };
                            
                            // Timeout f√ºr einzelne Bilder
                            setTimeout(() => {
                                iosDebugger.error(`Image ${index + 1} timeout after 3s`);
                                resolve(null);
                            }, 3000);
                            
                            img.src = base64Data;
                        } catch (error) {
                            iosDebugger.error(`Image ${index + 1} processing error`, error);
                            resolve(null);
                        }
                    });
                }

                // Batch-Processing f√ºr iOS mit Debug
                async function processPhotosForIOS(photos, maxPhotos = 5) {
                    iosDebugger.log(`Processing ${photos.length} photos (max: ${maxPhotos})`);
                    
                    const processedPhotos = [];
                    const photosToProcess = Math.min(photos.length, maxPhotos);
                    
                    for (let i = 0; i < photosToProcess; i++) {
                        iosDebugger.log(`Processing photo ${i + 1}/${photosToProcess}`);
                        iosDebugger.log(iosDebugger.getMemoryInfo());
                        
                        try {
                            const compressedImage = await compressImageForIOS(photos[i].data, i);
                            if (compressedImage) {
                                processedPhotos.push(compressedImage);
                                iosDebugger.log(`Photo ${i + 1} processed successfully`);
                            } else {
                                iosDebugger.log(`Photo ${i + 1} failed to process`);
                            }
                            
                            // Kleine Pause zwischen Bildern um Memory zu entlasten
                            if (i < photosToProcess - 1) {
                                iosDebugger.log(`Pausing 200ms before next photo...`);
                                await new Promise(resolve => setTimeout(resolve, 200));
                            }
                        } catch (error) {
                            iosDebugger.error(`Photo ${i + 1} batch error`, error);
                        }
                    }
                    
                    iosDebugger.log(`Batch processing complete: ${processedPhotos.length}/${photosToProcess} photos processed`);
                    return processedPhotos;
                }

                // Questions and Answers
                iosDebugger.log(`Processing ${survey.questions.length} questions...`);
                
                for (let i = 0; i < survey.questions.length; i++) {
                    const question = survey.questions[i];
                    iosDebugger.log(`Processing question ${i + 1}: ${question.text.slice(0, 30)}...`);
                    
                    if (yPosition > pageHeight - 50) {
                        doc.addPage();
                        yPosition = 30;
                        iosDebugger.log('Added new page');
                    }

                    // Question
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    const questionText = `${i + 1}. ${question.text}`;
                    const questionLines = doc.splitTextToSize(questionText, maxWidth);
                    doc.text(questionLines, margin, yPosition);
                    yPosition += questionLines.length * 6 + 5;

                    // Answer
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'normal');
                    const responseKey = `q${question.id}`;
                    let answer = responses[responseKey] || 'Keine Antwort';
                    
                    if (Array.isArray(answer)) {
                        answer = answer.join(', ');
                    }

                    if (question.type === 'rating' && answer !== 'Keine Antwort') {
                        const stars = '‚òÖ'.repeat(parseInt(answer));
                        const emptyStars = '‚òÜ'.repeat(5 - parseInt(answer));
                        answer = `${answer}/5 ${stars}${emptyStars}`;
                    }

                    const answerLines = doc.splitTextToSize(`Antwort: ${answer}`, maxWidth);
                    doc.text(answerLines, margin, yPosition);
                    yPosition += answerLines.length * 6;

                    // Fotos f√ºr iOS - bis zu 5 Bilder pro Frage
                    if (questionPhotos[question.id] && questionPhotos[question.id].length > 0) {
                        iosDebugger.log(`Question ${i + 1} has ${questionPhotos[question.id].length} photos`);
                        yPosition += 5;
                        doc.setFontSize(9);
                        doc.text(`üì∑ Bilder (${questionPhotos[question.id].length}):`, margin, yPosition);
                        yPosition += 8;

                        try {
                            // Batch-Processing f√ºr bis zu 5 Bilder
                            const processedImages = await processPhotosForIOS(questionPhotos[question.id], 5);
                            iosDebugger.log(`Question ${i + 1}: ${processedImages.length} images ready for PDF`);
                            
                            for (let imgIndex = 0; imgIndex < processedImages.length; imgIndex++) {
                                const compressedImage = processedImages[imgIndex];
                                
                                if (yPosition > pageHeight - 30) {
                                    doc.addPage();
                                    yPosition = 30;
                                    iosDebugger.log('Added new page for images');
                                }

                                try {
                                    iosDebugger.log(`Adding image ${imgIndex + 1} to PDF...`);
                                    
                                    const img = new Image();
                                    await new Promise((resolve, reject) => {
                                        const timeout = setTimeout(() => {
                                            iosDebugger.error(`Image ${imgIndex + 1} PDF timeout`);
                                            reject(new Error('PDF Image Timeout'));
                                        }, 2000);
                                        
                                        img.onload = () => {
                                            clearTimeout(timeout);
                                            resolve();
                                        };
                                        img.onerror = () => {
                                            clearTimeout(timeout);
                                            reject(new Error('PDF Image Load Error'));
                                        };
                                        img.src = compressedImage;
                                    });

                                    // Ultra-kleine Bildgr√∂√üe f√ºr iOS (mehr Bilder m√∂glich)
                                    const aspectRatio = img.width / img.height;
                                    let imgWidth = 20;
                                    let imgHeight = 20 / aspectRatio;
                                    
                                    if (imgHeight > 20) {
                                        imgHeight = 20;
                                        imgWidth = 20 * aspectRatio;
                                    }

                                    // Bilder nebeneinander wenn Platz da ist
                                    const xOffset = margin + (imgIndex % 3) * (imgWidth + 5);
                                    const yOffset = yPosition + Math.floor(imgIndex / 3) * (imgHeight + 5);
                                    
                                    doc.addImage(compressedImage, 'JPEG', xOffset, yOffset, imgWidth, imgHeight);
                                    iosDebugger.log(`Image ${imgIndex + 1} added to PDF at ${xOffset},${yOffset}`);
                                    
                                    // Y-Position nur bei jeder 3. Bild-Reihe anpassen
                                    if ((imgIndex + 1) % 3 === 0 || imgIndex === processedImages.length - 1) {
                                        yPosition = yOffset + imgHeight + 5;
                                    }
                                } catch (error) {
                                    iosDebugger.error(`PDF Image ${imgIndex + 1} failed`, error);
                                    doc.setFontSize(8);
                                    doc.text(`üì∑ Bild ${imgIndex + 1}: Fehler`, margin, yPosition);
                                    yPosition += 8;
                                }
                            }
                            
                            // Hinweis wenn mehr Bilder vorhanden als verarbeitet
                            if (questionPhotos[question.id].length > 5) {
                                doc.setFontSize(8);
                                doc.text(`... und ${questionPhotos[question.id].length - 5} weitere Bilder (iOS-Limit: 5/Frage)`, margin, yPosition);
                                yPosition += 8;
                            }
                            
                        } catch (error) {
                            iosDebugger.error(`Question ${i + 1} photo processing failed`, error);
                            doc.setFontSize(8);
                            doc.text(`üì∑ ${questionPhotos[question.id].length} Bild(er): iOS-Verarbeitung fehlgeschlagen`, margin, yPosition);
                            yPosition += 8;
                        }
                    }

                    yPosition += 12;
                }

                // Sonstiges section - vereinfacht f√ºr iOS
                const sonstigesAnswers = Object.keys(responses).filter(key => key.startsWith('sonstiges_'));
                if (sonstigesAnswers.length > 0) {
                    iosDebugger.log(`Processing ${sonstigesAnswers.length} sonstiges answers...`);
                    
                    if (yPosition > pageHeight - 50) {
                        doc.addPage();
                        yPosition = 30;
                    }

                    doc.setFontSize(14);
                    doc.setFont(undefined, 'bold');
                    doc.text('Zus√§tzliche Anmerkungen:', margin, yPosition);
                    yPosition += 15;

                    let sonstigesIndex = 1;
                    for (const key of sonstigesAnswers) {
                        const answer = responses[key];
                        
                        if (answer && answer.trim()) {
                            doc.setFontSize(11);
                            doc.setFont(undefined, 'bold');
                            doc.text(`${sonstigesIndex}. `, margin, yPosition);
                            
                            doc.setFont(undefined, 'normal');
                            const answerLines = doc.splitTextToSize(answer, maxWidth - 10);
                            doc.text(answerLines, margin + 10, yPosition);
                            yPosition += answerLines.length * 5 + 5;

                            // Sonstiges-Fotos f√ºr iOS - nur Hinweis
                            if (questionPhotos[key] && questionPhotos[key].length > 0) {
                                doc.setFontSize(8);
                                doc.text(`üì∑ ${questionPhotos[key].length} Bild(er) angeh√§ngt (iOS: nicht dargestellt)`, margin + 10, yPosition);
                                yPosition += 8;
                            }

                            yPosition += 10;
                            sonstigesIndex++;
                        }
                    }
                }

                // Save PDF
                iosDebugger.log('Saving PDF...');
                const filename = `Budni_Survey_${survey.title.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().slice(0,10)}.pdf`;
                doc.save(filename);
                iosDebugger.log('PDF saved successfully!');

                // Spezielle iOS-Nachricht
                let message = 'PDF wurde erfolgreich erstellt!';
                const totalPhotos = Object.values(questionPhotos).reduce((sum, photos) => sum + (photos ? photos.length : 0), 0);
                if (totalPhotos > 0) {
                    const maxPossiblePhotos = survey.questions.length * 5; // 5 pro Frage
                    const actualPhotos = Math.min(totalPhotos, maxPossiblePhotos);
                    message += `\n\nüì± iOS-Version: ${actualPhotos} von ${totalPhotos} Bildern eingebettet`;
                    if (totalPhotos > maxPossiblePhotos) {
                        message += `\n(iOS-Limit: max. 5 Bilder pro Frage)`;
                    }
                }
                
                alert(message);
                
                questionPhotos = {};
                sonstigesCounter = 0;
                backToSurveyList();

            } catch (error) {
                iosDebugger.error('iOS PDF Generation failed', error);
                iosDebugger.log(iosDebugger.getMemoryInfo());
                
                // iOS Fallback: PDF ohne Bilder
                try {
                    iosDebugger.log('Attempting text-only fallback...');
                    alert('Bild-Verarbeitung auf iOS fehlgeschlagen. Erstelle PDF nur mit Text...');
                    await generateTextOnlyPDF(survey, responses);
                } catch (fallbackError) {
                    iosDebugger.error('iOS Fallback failed', fallbackError);
                    throw error;
                }
            }
        }

        // Text-only PDF Fallback f√ºr iOS
        async function generateTextOnlyPDF(survey, responses) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            let yPosition = 30;
            const pageHeight = doc.internal.pageSize.height;
            const pageWidth = doc.internal.pageSize.width;
            const margin = 20;
            const maxWidth = pageWidth - 2 * margin;

            // Header
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text('BUDNI SURVEY TOOL', margin, yPosition);
            yPosition += 10;
            
            doc.setFontSize(14);
            doc.text(survey.title, margin, yPosition);
            yPosition += 15;

            doc.setFontSize(10);
            doc.text(`Ausgef√ºllt am: ${new Date().toLocaleDateString('de-DE')} (iOS Text-Version)`, margin, yPosition);
            yPosition += 20;

            // Questions ohne Bilder
            for (let i = 0; i < survey.questions.length; i++) {
                const question = survey.questions[i];
                
                if (yPosition > pageHeight - 40) {
                    doc.addPage();
                    yPosition = 30;
                }

                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                const questionText = `${i + 1}. ${question.text}`;
                const questionLines = doc.splitTextToSize(questionText, maxWidth);
                doc.text(questionLines, margin, yPosition);
                yPosition += questionLines.length * 6 + 5;

                doc.setFontSize(11);
                doc.setFont(undefined, 'normal');
                const responseKey = `q${question.id}`;
                let answer = responses[responseKey] || 'Keine Antwort';
                
                if (Array.isArray(answer)) {
                    answer = answer.join(', ');
                }

                if (question.type === 'rating' && answer !== 'Keine Antwort') {
                    const stars = '‚òÖ'.repeat(parseInt(answer));
                    const emptyStars = '‚òÜ'.repeat(5 - parseInt(answer));
                    answer = `${answer}/5 ${stars}${emptyStars}`;
                }

                const answerLines = doc.splitTextToSize(`Antwort: ${answer}`, maxWidth);
                doc.text(answerLines, margin, yPosition);
                yPosition += answerLines.length * 6;

                // Nur Hinweis auf Fotos
                if (questionPhotos[question.id] && questionPhotos[question.id].length > 0) {
                    doc.setFontSize(9);
                    doc.text(`üì∑ ${questionPhotos[question.id].length} Foto(s) wurden aufgenommen`, margin, yPosition);
                    yPosition += 8;
                }

                yPosition += 10;
            }

            // Sonstiges
            const sonstigesAnswers = Object.keys(responses).filter(key => key.startsWith('sonstiges_'));
            if (sonstigesAnswers.length > 0) {
                if (yPosition > pageHeight - 40) {
                    doc.addPage();
                    yPosition = 30;
                }

                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('Zus√§tzliche Anmerkungen:', margin, yPosition);
                yPosition += 15;

                let sonstigesIndex = 1;
                for (const key of sonstigesAnswers) {
                    const answer = responses[key];
                    
                    if (answer && answer.trim()) {
                        doc.setFontSize(11);
                        doc.setFont(undefined, 'bold');
                        doc.text(`${sonstigesIndex}. `, margin, yPosition);
                        
                        doc.setFont(undefined, 'normal');
                        const answerLines = doc.splitTextToSize(answer, maxWidth - 10);
                        doc.text(answerLines, margin + 10, yPosition);
                        yPosition += answerLines.length * 5 + 5;

                        if (questionPhotos[key] && questionPhotos[key].length > 0) {
                            doc.setFontSize(9);
                            doc.text(`üì∑ ${questionPhotos[key].length} Foto(s) wurden aufgenommen`, margin + 10, yPosition);
                            yPosition += 8;
                        }

                        yPosition += 10;
                        sonstigesIndex++;
                    }
                }
            }

            const filename = `Budni_Survey_TextOnly_${survey.title.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().slice(0,10)}.pdf`;
            doc.save(filename);

            alert('iOS Text-PDF wurde erfolgreich erstellt! (Bilder konnten nicht eingebettet werden)');
            
            questionPhotos = {};
            sonstigesCounter = 0;
            backToSurveyList();
        }

        // Full PDF for desktop/non-iOS browsers
        async function generateFullPDF(survey, responses) {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                let yPosition = 30;
                const pageHeight = doc.internal.pageSize.height;
                const pageWidth = doc.internal.pageSize.width;
                const margin = 20;
                const maxWidth = pageWidth - 2 * margin;
                const primaryColor = [102, 126, 234]; // #667eea
                const secondaryColor = [118, 75, 162]; // #764ba2
                const lightGray = [248, 249, 250];
                const darkGray = [108, 117, 125];

                // Professional Header
                doc.setFillColor(...primaryColor);
                doc.rect(0, 0, pageWidth, 25, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(20);
                doc.setFont(undefined, 'bold');
                doc.text('BUDNI SURVEY TOOL', margin, 16);
                
                // Professional subtitle bar
                doc.setFillColor(...lightGray);
                doc.rect(0, 25, pageWidth, 8, 'F');

                // Reset text color
                doc.setTextColor(0, 0, 0);

                // Document Info Section
                yPosition = 45;
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(...primaryColor);
                doc.text(survey.title, margin, yPosition);
                yPosition += 12;

                // Info Box
                doc.setFillColor(...lightGray);
                doc.roundedRect(margin, yPosition - 2, maxWidth, 25, 3, 3, 'F');
                
                doc.setFontSize(10);
                doc.setTextColor(...darkGray);
                doc.setFont(undefined, 'normal');
                
                const currentDate = new Date();
                const dateStr = currentDate.toLocaleDateString('de-DE', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                const timeStr = currentDate.toLocaleTimeString('de-DE');
                
                doc.text(`Ausgef√ºllt am: ${dateStr}`, margin + 5, yPosition + 6);
                doc.text(`Uhrzeit: ${timeStr}`, margin + 5, yPosition + 12);
                doc.text(`Anzahl Fragen: ${survey.questions.length}`, margin + 5, yPosition + 18);
                
                yPosition += 35;

                // Description
                if (survey.description && survey.description.trim()) {
                    doc.setFontSize(11);
                    doc.setTextColor(0, 0, 0);
                    doc.setFont(undefined, 'italic');
                    const descLines = doc.splitTextToSize(survey.description, maxWidth);
                    doc.text(descLines, margin, yPosition);
                    yPosition += descLines.length * 5 + 15;
                }

                // Separator line
                doc.setDrawColor(...primaryColor);
                doc.setLineWidth(0.5);
                doc.line(margin, yPosition, pageWidth - margin, yPosition);
                yPosition += 15;

                // Enhanced image compression for non-iOS
                function compressImage(base64Data, maxWidth = 300, quality = 0.5) {
                    return new Promise((resolve) => {
                        try {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            const img = new Image();
                            
                            img.onload = function() {
                                const aspectRatio = img.width / img.height;
                                let newWidth = Math.min(img.width, maxWidth);
                                let newHeight = newWidth / aspectRatio;
                                
                                canvas.width = newWidth;
                                canvas.height = newHeight;
                                
                                ctx.drawImage(img, 0, 0, newWidth, newHeight);
                                const compressedData = canvas.toDataURL('image/jpeg', quality);
                                resolve(compressedData);
                            };
                            
                            img.onerror = function() {
                                resolve(base64Data); // fallback to original
                            };
                            
                            img.src = base64Data;
                        } catch (error) {
                            resolve(base64Data); // fallback to original
                        }
                    });
                }

                // Questions and answers with images
                for (let i = 0; i < survey.questions.length; i++) {
                    const question = survey.questions[i];
                    
                    if (yPosition > pageHeight - 60) {
                        doc.addPage();
                        yPosition = 30;
                    }

                    // Question
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(...primaryColor);
                    
                    const questionText = `${i + 1}. ${question.text}`;
                    const questionLines = doc.splitTextToSize(questionText, maxWidth);
                    doc.text(questionLines, margin, yPosition);
                    yPosition += questionLines.length * 6 + 3;

                    // Question type indicator
                    doc.setFontSize(8);
                    doc.setTextColor(...darkGray);
                    const typeLabels = {
                        'text': 'Textantwort',
                        'textarea': 'Freitext',
                        'radio': 'Einzelauswahl',
                        'checkbox': 'Mehrfachauswahl',
                        'dropdown': 'Dropdown-Auswahl',
                        'rating': 'Bewertung'
                    };
                    doc.text(`[${typeLabels[question.type] || question.type}]`, margin, yPosition);
                    yPosition += 8;

                    // Answer box
                    doc.setFillColor(250, 250, 250);
                    const answerBoxHeight = 15;
                    doc.roundedRect(margin, yPosition - 2, maxWidth, answerBoxHeight, 2, 2, 'F');
                    
                    // Answer text
                    doc.setFontSize(11);
                    doc.setTextColor(0, 0, 0);
                    doc.setFont(undefined, 'normal');
                    const responseKey = `q${question.id}`;
                    let answer = responses[responseKey] || 'Keine Antwort';
                    
                    if (Array.isArray(answer)) {
                        answer = answer.join(', ');
                    }

                    if (question.type === 'rating' && answer !== 'Keine Antwort') {
                        const stars = '‚≠ê'.repeat(parseInt(answer));
                        const emptyStars = '‚òÜ'.repeat(5 - parseInt(answer));
                        answer = `${answer}/5 ${stars}${emptyStars}`;
                    }

                    const answerLines = doc.splitTextToSize(answer, maxWidth - 10);
                    doc.text(answerLines, margin + 5, yPosition + 6);
                    yPosition += Math.max(answerBoxHeight, answerLines.length * 5) + 5;

                    // Photos with compression
                    if (questionPhotos[question.id] && questionPhotos[question.id].length > 0) {
                        yPosition += 5;
                        doc.setFontSize(9);
                        doc.setTextColor(...darkGray);
                        doc.text(`üì∑ Anh√§nge (${questionPhotos[question.id].length} Foto(s)):`, margin, yPosition);
                        yPosition += 8;

                        for (const photo of questionPhotos[question.id]) {
                            if (yPosition > pageHeight - 50) {
                                doc.addPage();
                                yPosition = 30;
                            }

                            try {
                                const compressedImage = await compressImage(photo.data, 250, 0.4);
                                
                                const img = new Image();
                                await new Promise((resolve, reject) => {
                                    img.onload = resolve;
                                    img.onerror = reject;
                                    img.src = compressedImage;
                                });

                                const aspectRatio = img.width / img.height;
                                let imgWidth = 35;
                                let imgHeight = 35 / aspectRatio;
                                
                                if (imgHeight > 35) {
                                    imgHeight = 35;
                                    imgWidth = 35 * aspectRatio;
                                }

                                doc.setDrawColor(200, 200, 200);
                                doc.setLineWidth(0.2);
                                doc.rect(margin, yPosition, imgWidth, imgHeight);
                                doc.addImage(compressedImage, 'JPEG', margin, yPosition, imgWidth, imgHeight);
                                yPosition += imgHeight + 8;
                            } catch (error) {
                                console.warn('Bild-Fehler:', error);
                                doc.setFontSize(8);
                                doc.setTextColor(200, 0, 0);
                                doc.text('‚ö† Bild konnte nicht geladen werden', margin, yPosition);
                                yPosition += 8;
                            }
                        }
                    }

                    yPosition += 12;
                }

                // Sonstiges section (similar structure for brevity)
                const sonstigesAnswers = Object.keys(responses).filter(key => key.startsWith('sonstiges_'));
                if (sonstigesAnswers.length > 0) {
                    if (yPosition > pageHeight - 60) {
                        doc.addPage();
                        yPosition = 30;
                    }

                    doc.setFillColor(...primaryColor);
                    doc.rect(margin, yPosition - 5, maxWidth, 12, 'F');
                    doc.setFontSize(14);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(255, 255, 255);
                    doc.text('ZUS√ÑTZLICHE ANMERKUNGEN', margin + 5, yPosition + 3);
                    yPosition += 20;

                    // Process sonstiges answers with photos...
                    // (keeping similar structure as before but with better error handling)
                }

                // Professional Footer
                const totalPages = doc.internal.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    doc.setPage(i);
                    
                    doc.setDrawColor(...primaryColor);
                    doc.setLineWidth(0.3);
                    doc.line(margin, pageHeight - 15, pageWidth - margin, pageHeight - 15);
                    
                    doc.setFontSize(8);
                    doc.setTextColor(...darkGray);
                    doc.setFont(undefined, 'normal');
                    doc.text(`Seite ${i} von ${totalPages}`, pageWidth - margin - 20, pageHeight - 8);
                    doc.text(`Budni Survey Tool - ${new Date().toLocaleDateString('de-DE')}`, margin, pageHeight - 8);
                }

                const filename = `Budni_Survey_${survey.title.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().slice(0,10)}.pdf`;
                doc.save(filename);

                alert('Professionelles PDF wurde erfolgreich erstellt und heruntergeladen!');
                
                questionPhotos = {};
                sonstigesCounter = 0;
                backToSurveyList();

            } catch (error) {
                console.error('Full PDF Error:', error);
                throw error;
            }
        }
    </script>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; align-items: center; justify-content: center; gap: 15px;">
                <svg width="50" height="50" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <!-- Orange shape -->
                    <path d="M45 15 C65 10, 85 25, 85 45 C85 65, 70 85, 50 85 C40 85, 30 80, 25 70 C20 60, 25 45, 35 35 C40 25, 42 18, 45 15 Z" fill="#FF6B35" opacity="0.8"/>
                    <!-- Cyan shape -->
                    <path d="M15 25 C5 35, 5 55, 15 65 C25 75, 40 75, 50 65 C60 55, 65 40, 60 25 C55 15, 45 10, 35 15 C25 20, 20 22, 15 25 Z" fill="#00BCD4" opacity="0.8"/>
                    <!-- Main blue circle -->
                    <circle cx="50" cy="50" r="30" fill="#1E3A8A"/>
                    <!-- budni text -->
                    <text x="50" y="58" text-anchor="middle" fill="white" font-family="Arial, sans-serif" font-size="12" font-weight="bold">budni</text>
                </svg>
                <h1 style="margin: 0;">Budni Survey Tool</h1>
            </div>
        </div>

        <div class="mode-selector">
            <button class="mode-btn" onclick="switchMode('designer')">
                üé® Designer-Modus
            </button>
            <button class="mode-btn active" onclick="switchMode('survey')">
                üìù Umfrage-Modus
            </button>
        </div>

        <div class="main-content">
            <!-- Designer Mode -->
            <div id="designer-mode" class="hidden">
                <div class="form-builder">
                    <div class="sidebar">
                        <h3>üìù Fragetypen</h3>
                        <div class="question-types">
                            <button class="question-type-btn" onclick="addQuestion('text')">
                                üìù Textfeld
                            </button>
                            <button class="question-type-btn" onclick="addQuestion('textarea')">
                                üìÑ Textbereich
                            </button>
                            <button class="question-type-btn" onclick="addQuestion('radio')">
                                üîò Single Choice
                            </button>
                            <button class="question-type-btn" onclick="addQuestion('checkbox')">
                                ‚òëÔ∏è Multiple Choice
                            </button>
                            <button class="question-type-btn" onclick="addQuestion('rating')">
                                ‚≠ê Bewertung (1-5)
                            </button>
                            <button class="question-type-btn" onclick="addQuestion('dropdown')">
                                üìã Dropdown
                            </button>
                        </div>

                        <h3 style="margin-top: 30px;">üíæ Aktionen</h3>
                        <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 15px;">
                            <input type="file" id="fileInput" class="file-input" accept=".json" onchange="loadSurvey(event)">
                            <label for="fileInput" class="file-label">üìÅ Umfrage laden</label>
                            <button class="file-label" onclick="saveSurvey()" style="border: none; width: 100%;">üíæ Umfrage speichern</button>
                            <button class="file-label" onclick="clearSurvey()" style="border: none; width: 100%; background: #ff6b6b;">üóëÔ∏è Alles l√∂schen</button>
                        </div>
                    </div>

                    <div class="form-preview">
                        <div class="survey-header">
                            <input type="text" id="surveyTitle" placeholder="Titel der Umfrage..." value="Meine Umfrage">
                            <textarea id="surveyDescription" placeholder="Beschreibung der Umfrage...">Vielen Dank f√ºr Ihre Teilnahme an unserer Umfrage!</textarea>
                        </div>

                        <div id="questionsContainer">
                            <!-- Questions will be added here -->
                        </div>

                        <div class="form-actions">
                            <button class="action-btn primary" onclick="previewSurvey()">
                                üëÅÔ∏è Vorschau
                            </button>
                            <button class="action-btn secondary" onclick="generateSurveyLink()">
                                üîó Link generieren
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Survey Mode -->
            <div id="survey-mode">
                <div id="survey-selection">
                    <h2 style="text-align: center; margin-bottom: 20px; color: #667eea;">Verf√ºgbare Umfragen</h2>
                    <div class="survey-list" id="surv